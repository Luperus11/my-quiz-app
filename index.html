<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏ß‡πá‡∏ö‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå (Fixed)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f0f2f5; }
        .container { max-width: 700px; }
        .card { border: none; border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        #alert-container { position: fixed; top: 1rem; right: 1rem; z-index: 1055; min-width: 250px; }
        .hidden { display: none !important; }
        .mic-listening { color: #dc3545; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); } }
    </style>
</head>
<body>
    <div class="container my-4">
        <main id="app-root"></main>
    </div>

    <div id="alert-container"></div>
    
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
        <div id="due-toast" class="toast hide" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto">üîî ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                <p id="due-toast-message">‡∏°‡∏µ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ñ‡∏∂‡∏á‡∏£‡∏≠‡∏ö‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß!</p>
                <button id="start-due-toast-btn" class="btn btn-primary btn-sm w-100">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡πÄ‡∏•‡∏¢</button>
            </div>
        </div>
    </div>

    <div class="modal fade" id="historyModal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="history-modal-title">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="history-modal-body"></div></div></div></div>
    
    <div class="modal fade" id="startSessionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="category-select" class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</label>
                        <select id="category-select" class="form-select">
                            <option value="all">‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                            <option value="due">‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏ñ‡∏∂‡∏á‡∏£‡∏≠‡∏ö‡∏ó‡∏ß‡∏ô</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="button" id="confirm-start-btn" class="btn btn-primary">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</button></div>
            </div>
        </div>
    </div>

    <template id="template-main-menu"><div class="card"><div class="card-body"><div class="d-flex justify-content-between align-items-center mb-4"><h5 class="mb-0" id="welcome-message">‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå</h5></div><div class="text-center p-2"><h1 class="text-primary mb-3">‡πÄ‡∏ß‡πá‡∏ö‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå</h1><p class="text-muted mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</p><div class="d-grid gap-3"><button id="start-new-btn" class="btn btn-primary btn-lg"><i class="bi bi-stars"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô</button><button id="manage-btn" class="btn btn-outline-secondary"><i class="bi bi-gear-fill"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button><button id="dashboard-btn" class="btn btn-outline-info"><i class="bi bi-graph-up"></i> ‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</button></div></div></div></div></template>
    
    <template id="template-test">
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h3 class="fs-5 mb-0"><i class="bi bi-robot"></i> Voice-Guided Mode</h3>
                <span id="due-count-badge" class="badge bg-light text-dark"></span>
            </div>
            <div class="card-body text-center" id="quiz-area"></div>
            <div id="debug-info" class="card-footer bg-light text-muted small" style="font-family: monospace;">
            </div>
        </div>
    </template>

    <template id="template-manage"><button id="back-to-menu-btn" class="btn btn-secondary mb-3 w-100"><i class="bi bi-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button><div class="card mb-4"><div class="card-header bg-info text-white"><h5><i class="bi bi-plus-circle-fill"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà (‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ)</h5></div><div class="card-body"><form id="add-form"><div class="mb-3"><label for="new-question" class="form-label">‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ (‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©, ‡πÄ‡∏ß‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ___)</label><input type="text" id="new-question" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô The ___ stores electrical energy." required></div><div class="mb-3"><label for="new-answer-word" class="form-label">‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö (‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á)</label><input type="text" id="new-answer-word" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô capacitor" required></div><div class="mb-3"><label for="new-hint" class="form-label">‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ (‡πÑ‡∏ó‡∏¢)</label><input type="text" id="new-hint" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡∏à‡∏∏‡πÉ‡∏ä‡πâ‡πÄ‡∏Å‡πá‡∏ö‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÑ‡∏ü‡∏ü‡πâ‡∏≤" required></div><div class="mb-3"><label for="new-category" class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label><input type="text" id="new-category" class="form-control" required></div><button type="submit" class="btn btn-success w-100">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button></form></div></div><div class="card"><div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center"><h5><i class="bi bi-card-list"></i> ‡∏Ñ‡∏•‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h5><button id="reset-data-btn" class="btn btn-danger btn-sm"><i class="bi bi-trash3-fill"></i> ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button></div><div class="card-body"><div id="questions-list" class="table-responsive"></div></div></div></template>
    
    <template id="template-dashboard">
        <button id="back-to-menu-btn" class="btn btn-secondary mb-3 w-100"><i class="bi bi-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
        <div class="card mb-4">
            <div class="card-header bg-primary text-white"><h5><i class="bi bi-speedometer2"></i> ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</h5></div>
            <div class="card-body">
                <div class="row text-center mb-4">
                    <div class="col"><h4 class="mb-0 text-primary" id="total-questions">0</h4><small class="text-muted">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small></div>
                    <div class="col"><h4 class="mb-0 text-warning" id="due-for-review">0</h4><small class="text-muted">‡∏ñ‡∏∂‡∏á‡∏£‡∏≠‡∏ö‡∏ó‡∏ß‡∏ô</small></div>
                </div>
                <hr>
                <h6 class="mb-3">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á Level (‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç)</h6>
                <div style="position: relative; height:300px; width:100%" class="mb-4">
                    <canvas id="levelChart"></canvas>
                </div>
                <hr>
                <h6 class="mb-3">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h6>
                <div style="position: relative; height:300px; width:100%">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>
    </template>

    <script>
        
        // **********************************************
        // START: INITIAL_QUESTIONS (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÅ‡∏•‡πâ‡∏ß)
        // **********************************************
        const INITIAL_QUESTIONS = [
            { question: "I need to go to the ___.", answer: "market", hint: "‡∏â‡∏±‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏õ‡∏ï‡∏•‡∏≤‡∏î", category: "Daily Conversation" },
            { question: "Can you help me ___ this?", answer: "find", hint: "‡∏Ñ‡∏∏‡∏ì‡∏ä‡πà‡∏ß‡∏¢‡∏â‡∏±‡∏ô‡∏´‡∏≤‡∏≠‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°", category: "Daily Conversation" },
            { question: "What time is it ___?", answer: "now", hint: "‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡∏µ‡πà‡πÇ‡∏°‡∏á‡πÅ‡∏•‡πâ‡∏ß", category: "Daily Conversation" },
            { question: "I want a cup of ___.", answer: "coffee", hint: "‡∏â‡∏±‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡πÅ‡∏ü‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÅ‡∏Å‡πâ‡∏ß", category: "Daily Conversation" },
            { question: "Have a nice ___.", answer: "day", hint: "‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏µ", category: "Daily Conversation" }
        ];
        // **********************************************
        // END: INITIAL_QUESTIONS
        // **********************************************

        // Utility function for Levenshtein Distance (Added for strictness)
        const calculateLevenshteinDistance = (s1, s2) => {
            s1 = s1.toLowerCase();
            s2 = s2.toLowerCase();
            const costs = new Array();
            for (let i = 0; i <= s1.length; i++) {
                let lastValue = i;
                for (let j = 0; j <= s2.length; j++) {
                    if (i === 0) {
                        costs[j] = j;
                    } else if (j > 0) {
                        let newValue = costs[j - 1];
                        if (s1.charAt(i - 1) !== s2.charAt(j - 1)) {
                            newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                        }
                        costs[j - 1] = lastValue;
                        lastValue = newValue;
                    }
                }
                if (i > 0) costs[s2.length] = lastValue;
            }
            return costs[s2.length];
        };


        const LocalStorageService = {
            getQuestions: async () => {
                const data = localStorage.getItem('srsAppQuestions');
                if (!data) return [];
                const questions = JSON.parse(data);
                return questions.map(q => ({
                    ...q,
                    next_review_date: new Date(q.next_review_date),
                    created_at: q.created_at ? new Date(q.created_at) : new Date()
                }));
            },
            saveQuestions: async (questions) => {
                const dataToSave = questions.map(q => ({
                    ...q,
                    next_review_date: q.next_review_date.toISOString(),
                    created_at: (q.created_at || new Date()).toISOString()
                }));
                localStorage.setItem('srsAppQuestions', JSON.stringify(dataToSave));
            },
            addQuestion: async (data) => {
                const questions = await LocalStorageService.getQuestions();
                const newQuestion = {
                    ...data,
                    id: `local_${Date.now()}`
                };
                questions.push(newQuestion);
                await LocalStorageService.saveQuestions(questions);
            },
            deleteQuestion: async (wordId) => {
                let questions = await LocalStorageService.getQuestions();
                questions = questions.filter(q => q.id !== wordId);
                await LocalStorageService.saveQuestions(questions);
            },
            updateQuestion: async (wordId, data) => {
                let questions = await LocalStorageService.getQuestions();
                const qIndex = questions.findIndex(q => q.id === wordId);
                if (qIndex > -1) {
                    questions[qIndex] = { ...questions[qIndex], ...data };
                    await LocalStorageService.saveQuestions(questions);
                }
            },
            async addInitialQuestionsForNewUser() {
                const data = localStorage.getItem('srsAppQuestions');
                if (data) return;
                const initialData = INITIAL_QUESTIONS.map(q => ({
                    ...q,
                    id: `local_${Date.now()}_${Math.random()}`,
                    srs_level: 0,
                    next_review_date: new Date(),
                    created_at: new Date()
                }));
                await LocalStorageService.saveQuestions(initialData);
            }
        };

        const SpeechService = {
            recognition: null, isListening: false,
            init: () => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    console.warn("Browser does not support Speech Recognition");
                    return;
                }
                SpeechService.recognition = new SpeechRecognition();
                SpeechService.recognition.continuous = false;
                SpeechService.recognition.interimResults = false;
                SpeechService.recognition.onresult = (event) => App.handleSpeechInput(event.results[0][0].transcript.trim());
                SpeechService.recognition.onerror = (event) => {
                    console.error("Speech Error:", event.error);
                    if (event.error === 'no-speech') {
                        const currentState = App.quizSession.currentState;
                        if (currentState === 'AWAITING_ANSWER' || currentState === 'AWAITING_LEVEL') {
                            SpeechService.speak('‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏±‡∏ö', 'th-TH', () => {
                                const lang = (currentState === 'AWAITING_ANSWER') ? 'en-US' : 'th-TH';
                                const micIcon = document.querySelector('#quiz-area .bi-mic-fill');
                                if (micIcon) micIcon.classList.add('mic-listening');
                                if(document.getElementById('status-text')) document.getElementById('status-text').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á...';
                                SpeechService.listen(lang);
                            });
                        }
                    } else if (event.error !== 'aborted' && event.error !== 'network') {
                        App.showAlert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á: ${event.error}`, 'danger');
                    }
                };
                SpeechService.recognition.onend = () => App.handleSpeechEnd();
            },
            speak: (text, lang, onEndCallback = null) => {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = lang;
                    utterance.rate = (lang === 'th-TH') ? 0.9 : 1.0;
                    if (onEndCallback) utterance.onend = onEndCallback;
                    window.speechSynthesis.speak(utterance);
                } else if (onEndCallback) { onEndCallback(); }
            },
            cancelSpeech: () => { if ('speechSynthesis' in window) { window.speechSynthesis.cancel(); } },
            listen: (lang) => {
                if (!SpeechService.recognition) return;
                if (SpeechService.isListening) {
                    SpeechService.recognition.stop();
                }
                SpeechService.recognition.lang = lang;
                SpeechService.isListening = true;
                try {
                    SpeechService.recognition.start();
                } catch (e) {
                    console.error("Speech recognition start error:", e);
                    SpeechService.isListening = false;
                }
            },
        };

        const RecordingService = {
            mediaRecorder: null, audioChunks: [], isRecording: false, stream: null,
            startRecording: async () => {
                if (RecordingService.isRecording) return;
                
                if(location.protocol === 'file:') {
                    App.showAlert('‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (file://) ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏±‡∏ô‡∏ú‡πà‡∏≤‡∏ô Local Server', 'warning');
                }

                if (!navigator.mediaDevices?.getUserMedia) return App.showAlert('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á', 'danger');
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    RecordingService.stream = stream;
                    RecordingService.mediaRecorder = new MediaRecorder(stream);
                    RecordingService.audioChunks = [];
                    RecordingService.mediaRecorder.ondataavailable = event => RecordingService.audioChunks.push(event.data);
                    RecordingService.mediaRecorder.start();
                    RecordingService.isRecording = true;
                } catch (err) { 
                    console.error(err);
                    App.showAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡πÑ‡∏î‡πâ (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Permission)', 'danger'); 
                }
            },
            stopRecording: () => {
                return new Promise(resolve => {
                    if (!RecordingService.mediaRecorder || RecordingService.mediaRecorder.state === "inactive") return resolve(null);
                    RecordingService.mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(RecordingService.audioChunks, { type: 'audio/webm' });
                        RecordingService.stream?.getTracks().forEach(track => track.stop());
                        RecordingService.stream = null;
                        RecordingService.isRecording = false;
                        resolve(audioBlob);
                    };
                    RecordingService.mediaRecorder.stop();
                });
            }
        };

        const IndexedDBService = {
            db: null,
            init: () => {
                return new Promise((resolve, reject) => {
                    if (IndexedDBService.db) return resolve();
                    const request = indexedDB.open('audioHistoryDB', 1);
                    request.onerror = () => reject("Database error");
                    request.onsuccess = event => { IndexedDBService.db = event.target.result; resolve(); };
                    request.onupgradeneeded = event => {
                        if(!event.target.result.objectStoreNames.contains('recordings')) {
                            event.target.result.createObjectStore('recordings', { keyPath: 'id', autoIncrement: true });
                        }
                    };
                });
            },
            addRecording: (wordId, audioBlob) => {
                return new Promise((resolve, reject) => {
                    const transaction = IndexedDBService.db.transaction(['recordings'], 'readwrite');
                    const store = transaction.objectStore('recordings');
                    const request = store.add({ wordId, audioBlob, timestamp: new Date() });
                    request.onsuccess = () => resolve();
                    request.onerror = event => reject(event.target.error);
                });
            },
            getRecordingsForWord: (wordId) => {
                return new Promise((resolve) => {
                    const recordings = [];
                    const transaction = IndexedDBService.db.transaction(['recordings'], 'readonly');
                    transaction.objectStore('recordings').openCursor().onsuccess = event => {
                        const cursor = event.target.result;
                        if (cursor) {
                            if (cursor.value.wordId === wordId) recordings.push(cursor.value);
                            cursor.continue();
                        } else {
                            resolve(recordings.sort((a, b) => a.timestamp - b.timestamp));
                        }
                    };
                });
            }
        };

        const App = {
            allUserQuestions: [], quizSession: {}, dueCheckInterval: null, activeQuizInterval: null,
            
            LEVEL_TO_MINUTES_MAP: { 
                1: 2,    // 2 ‡∏ô‡∏≤‡∏ó‡∏µ (‡∏ó‡∏ß‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)
                2: 10,   // 10 ‡∏ô‡∏≤‡∏ó‡∏µ
                3: 30,  // 30 ‡∏ô‡∏≤‡∏ó‡∏µ
                4: 60,  // 1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
                5: 180  // 3 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
            },
            
            async init() {
                try {
                    await IndexedDBService.init();
                    await LocalStorageService.addInitialQuestionsForNewUser();
                    this.allUserQuestions = await LocalStorageService.getQuestions();
                    SpeechService.init();
                    this.render('main-menu');
                    this.startDueItemsCheck();
                } catch (e) {
                    console.error("Init Error:", e);
                    this.showAlert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö: " + e.message, 'danger');
                }
            },

            render(page) {
                const appRoot = document.getElementById('app-root');
                appRoot.innerHTML = '';
                const template = document.getElementById(`template-${page}`);
                if(template) {
                    const content = template.content.cloneNode(true);
                    appRoot.appendChild(content);
                    this.bindPageEvents(page);
                }
            },
            
            bindPageEvents(page) {
                if (page === 'main-menu') {
                    document.getElementById('start-new-btn').addEventListener('click', () => this.showStartSessionModal());
                    document.getElementById('manage-btn').addEventListener('click', () => this.render('manage'));
                    document.getElementById('dashboard-btn').addEventListener('click', () => this.render('dashboard'));
                } else if (page === 'manage') {
                    document.getElementById('back-to-menu-btn').addEventListener('click', () => this.render('main-menu'));
                    this.renderManageList();
                    document.getElementById('add-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        await LocalStorageService.addQuestion({ 
                            question: e.target.elements['new-question'].value, 
                            answer: e.target.elements['new-answer-word'].value, 
                            hint: e.target.elements['new-hint'].value, 
                            category: e.target.elements['new-category'].value, 
                            srs_level: 0, 
                            next_review_date: new Date() 
                        });
                        this.showAlert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                        this.allUserQuestions = await LocalStorageService.getQuestions();
                        this.renderManageList();
                        e.target.reset();
                    });
                    document.getElementById('reset-data-btn').addEventListener('click', async () => {
                        if (confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ')) {
                            localStorage.removeItem('srsAppQuestions');
                            this.showAlert('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß', 'success');
                            this.allUserQuestions = [];
                            this.renderManageList();
                        }
                    });
                } else if (page === 'dashboard') {
                    document.getElementById('back-to-menu-btn').addEventListener('click', () => this.render('main-menu'));
                    this.renderDashboard();
                }
            },
            
            async renderDashboard() {
                const levelChartCtx = document.getElementById('levelChart')?.getContext('2d');
                const categoryChartCtx = document.getElementById('categoryChart')?.getContext('2d');

                if (!levelChartCtx || !categoryChartCtx) return;

                document.getElementById('total-questions').textContent = this.allUserQuestions.length;
                const now = new Date();
                const dueCount = this.allUserQuestions.filter(q => q.next_review_date <= now).length;
                document.getElementById('due-for-review').textContent = dueCount;
                
                const levelCounts = this.allUserQuestions.reduce((acc, q) => { 
                    const level = q.srs_level || 0;
                    acc[level] = (acc[level] || 0) + 1; 
                    return acc; 
                }, {});

                const levelData = { labels: [], data: [] };
                for (let i = 0; i <= 5; i++) {
                    levelData.labels.push(`Level ${i}`);
                    levelData.data.push(levelCounts[i] || 0);
                }

                // FIX: Destroy old charts if they exist
                const existingLevelChart = Chart.getChart("levelChart");
                if (existingLevelChart) existingLevelChart.destroy();
                
                const existingCategoryChart = Chart.getChart("categoryChart");
                if (existingCategoryChart) existingCategoryChart.destroy();

                new Chart(levelChartCtx, {
                    type: 'bar',
                    data: {
                        labels: levelData.labels,
                        datasets: [{
                            label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°',
                            data: levelData.data,
                            backgroundColor: ['#6c757d', '#dc3545', '#ffc107', '#0dcaf0', '#0d6efd', '#198754']
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                    }
                });

                const categoryCounts = this.allUserQuestions.reduce((acc, q) => { acc[q.category] = (acc[q.category] || 0) + 1; return acc; }, {});
                
                new Chart(categoryChartCtx, { 
                    type: 'pie', 
                    data: { 
                        labels: Object.keys(categoryCounts), 
                        datasets: [{ 
                            data: Object.values(categoryCounts), 
                            backgroundColor: Object.keys(categoryCounts).map((_, i) => `hsl(${i * 60}, 70%, 70%)`), 
                        }] 
                    }, 
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { legend: { position: 'right' } } 
                    } 
                });
            },
            
            formatTimeUntilNextReview(reviewDate) {
                if (!(reviewDate instanceof Date)) return '';
                const now = new Date();
                const diffMs = reviewDate.getTime() - now.getTime();
                if (diffMs <= 0) { return `<span class="badge bg-warning">0 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</span>`; }
                const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
                if (diffDays <= 1) return `<span class="badge bg-secondary">‡πÄ‡∏£‡πá‡∏ß‡πÜ‡∏ô‡∏µ‡πâ</span>`;
                return `<span class="badge bg-secondary">${diffDays} ‡∏ß‡∏±‡∏ô</span>`;
            },

            async renderManageList() {
                const listContainer = document.getElementById('questions-list');
                if (!listContainer) return;
                listContainer.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div></div>';
                if (this.allUserQuestions.length === 0) { listContainer.innerHTML = '<p class="text-center text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>'; return; }
                
                let tableHTML = `<table class="table table-striped table-hover"><thead><tr><th>ID</th><th>‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ / ‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th class="text-end">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody>`;
                
                this.allUserQuestions.sort((a,b)=>a.question.localeCompare(b.question)).forEach(q => {
                    const timeStatusBadge = this.formatTimeUntilNextReview(q.next_review_date);
                    
                    tableHTML += `<tr>
                        <td><small class="text-muted" style="word-break: break-all;">${q.id.toString().slice(-6)}</small></td>
                        <td>${q.question.replace('___', `<strong>${q.answer}</strong>`)}<br><small class="text-muted">${q.hint}</small><br><small class="text-info">${q.category}</small></td>
                        <td><span class="badge bg-info">Lv. ${q.srs_level}</span> ${timeStatusBadge}</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-info recording-history-btn" data-word-id="${q.id}" data-word-q="${q.answer}"><i class="bi bi-clock-history"></i></button> 
                            <button class="btn btn-sm btn-danger delete-btn" data-id="${q.id}">‡∏•‡∏ö</button>
                        </td>
                    </tr>`;
                });

                listContainer.innerHTML = tableHTML + `</tbody></table>`;
                listContainer.querySelectorAll('.delete-btn').forEach(b => b.addEventListener('click', async (e) => { if (confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?')) { await LocalStorageService.deleteQuestion(e.currentTarget.dataset.id); this.showAlert('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß', 'warning'); this.allUserQuestions = await LocalStorageService.getQuestions(); this.renderManageList(); } }));
                listContainer.querySelectorAll('.recording-history-btn').forEach(b => b.addEventListener('click', (e) => this.showRecordingHistory(e.currentTarget.dataset.wordId, e.currentTarget.dataset.wordQ)));
            },
            
            showStartSessionModal() {
                const categorySelect = document.getElementById('category-select');
                categorySelect.innerHTML = '<option value="all">‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option><option value="due">‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏ñ‡∏∂‡∏á‡∏£‡∏≠‡∏ö‡∏ó‡∏ß‡∏ô</option>';
                const categories = [...new Set(this.allUserQuestions.map(q => q.category))];
                categories.forEach(cat => categorySelect.add(new Option(`‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà: ${cat}`, cat)));
                const modal = new bootstrap.Modal(document.getElementById('startSessionModal'));
                modal.show();
                document.getElementById('confirm-start-btn').onclick = () => { modal.hide(); this.startSession({ category: categorySelect.value }); };
            },

            startSession(options) {
                this.quizSession = { ...options, dueQuestions: [], lastRecordingBlob: null, currentState: null };
                const now = new Date();
                let filteredQuestions;
                if (options.category === 'all') {
                    filteredQuestions = [...this.allUserQuestions];
                } else if (options.category === 'due') {
                    filteredQuestions = this.allUserQuestions.filter(q => q.next_review_date <= now);
                } else {
                    filteredQuestions = this.allUserQuestions.filter(q => q.category === options.category);
                }

                let isLesson = options.category.toLowerCase().startsWith('lesson');
                
                if (isLesson) {
                    this.quizSession.dueQuestions = filteredQuestions.sort((a,b) => a.question.localeCompare(b.question));
                } else {
                    this.quizSession.dueQuestions = filteredQuestions.sort(() => Math.random() - 0.5);
                }
                
                if (this.quizSession.dueQuestions.length === 0) {
                    this.showAlert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ô‡∏µ‡πâ', 'info');
                    return;
                }
                this.render('test');
                this.startActiveQuizDueCheck(); 
                this.nextCard();
            },

            nextCard() {
                SpeechService.cancelSpeech();
                this.updateDebugInfo();
                const badge = document.getElementById('due-count-badge');
                if (badge) badge.textContent = `‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${this.quizSession.dueQuestions.length}`;
                const nextQ = this.quizSession.dueQuestions.shift();
                if (nextQ) {
                    this.quizSession.currentQuestion = nextQ;
                    this.quizSession.lastRecordingBlob = null;
                    this.updateDebugInfo();
                    this.runCardSequence(nextQ, 'ask');
                } else {
                    this.quizSession.currentQuestion = null;
                    this.updateDebugInfo();
                    this.showAlert('‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!', 'success');
                    this.stopActiveQuizDueCheck(); 
                    this.render('main-menu');
                }
            },
            
            runCardSequence(q, step, data = {}) {
                const quizArea = document.getElementById('quiz-area');
                if (!quizArea) return;
                if (step === 'ask') {
                    quizArea.innerHTML = `<div class="my-4 p-3"><p class="fs-5 text-muted">‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏≥‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á:</p><h2 class="display-6 my-3">${q.question}</h2><i class="bi bi-mic-fill fs-1"></i><p id="status-text" class="text-muted mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏π‡∏î‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ...</p></div>`;
                    SpeechService.speak(q.hint, 'th-TH', () => {
                        SpeechService.speak('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏π‡∏î‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö', 'th-TH', () => {
                            const st = document.getElementById('status-text');
                            if(st) st.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö...';
                            const mic = document.querySelector('#quiz-area .bi-mic-fill');
                            if(mic) mic.classList.add('mic-listening');
                            this.quizSession.currentState = 'AWAITING_ANSWER';
                            RecordingService.startRecording();
                            SpeechService.listen('en-US');
                        });
                    });
                } else if (step === 'feedback') {
                    const fullSentence = q.question.replace('___', `<strong>${q.answer}</strong>`);
                    quizArea.innerHTML = `<div class="my-4 p-3"><h2 class="${data.isCorrect ? "text-success" : "text-danger"}">${data.isCorrect ? "‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!" : "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"}</h2><p class="text-muted">‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤: <strong class="text-dark">"${data.transcript || '...'}"</strong></p><hr><p class="mt-3">‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏Ñ‡∏∑‡∏≠:</p><h4 class="mt-3">${fullSentence}</h4></div>`;

                    if (data.isCorrect) {
                        quizArea.innerHTML += `<i class="bi bi-mic-fill fs-1 mt-4"></i><p id="status-text" class="text-muted mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏π‡∏î‡πÄ‡∏â‡∏•‡∏¢...</p>`;
                        SpeechService.speak(q.question.replace('___', q.answer), 'en-US', () => {
                            SpeechService.speak('‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≥‡πÑ‡∏î‡πâ‡∏î‡∏µ‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô? ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏≠‡∏Å‡πÄ‡∏•‡πÄ‡∏ß‡∏• 1 ‡∏ñ‡∏∂‡∏á 5', 'th-TH', () => {
                                const st = document.getElementById('status-text');
                                if(st) st.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏≠‡∏Å‡πÄ‡∏•‡πÄ‡∏ß‡∏• 1 ‡∏ñ‡∏∂‡∏á 5...';
                                const mic = document.querySelector('#quiz-area .bi-mic-fill');
                                if(mic) mic.classList.add('mic-listening');
                                this.quizSession.currentState = 'AWAITING_LEVEL';
                                SpeechService.listen('th-TH');
                            });
                        });
                    } else {
                        quizArea.innerHTML += `<p class="fs-5 text-muted mt-4">‡∏à‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á...</p><div class="spinner-border my-3" role="status"></div>`;
                        this.quizSession.dueQuestions.push(q);
                        this.updateDebugInfo();
                        const badge = document.getElementById('due-count-badge');
                        if (badge) badge.textContent = `‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${this.quizSession.dueQuestions.length}`;
                        SpeechService.speak(q.question.replace('___', q.answer), 'en-US', () => {
                            setTimeout(() => this.nextCard(), 2000);
                        });
                    }
                }
            },

            async handleSpeechInput(transcript) {
                const q = this.quizSession.currentQuestion;
                if (!q) return;
                if (this.quizSession.currentState === 'AWAITING_ANSWER') {
                    const blob = await RecordingService.stopRecording();
                    
                    const cleanString = (str) => str ? str.toLowerCase().replace(/[.,/#!$%^&*;:{}=\-_`~()]/g,"").trim() : "";
                    
                    const cleanedAnswer = cleanString(q.answer);
                    const cleanedTranscript = cleanString(transcript);
                    
                    let isCorrect = false;
                    let distance = -1;

                    if (cleanedAnswer === cleanedTranscript) {
                        isCorrect = true; // ‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å 100%
                    } else {
                        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Levenshtein Distance ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î
                        distance = calculateLevenshteinDistance(cleanedAnswer, cleanedTranscript);
                        
                        // ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (Tolerance)
                        // ‡πÉ‡∏´‡πâ‡∏ú‡∏¥‡∏î‡πÑ‡∏î‡πâ 20% ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 1 ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 2
                        const tolerance = Math.ceil(cleanedAnswer.length * 0.2); 
                        const finalTolerance = Math.max(1, Math.min(2, tolerance)); 
                        
                        if (distance <= finalTolerance) {
                            // ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏ñ‡∏π‡∏Å ‡πÅ‡∏°‡πâ‡∏à‡∏∞‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå
                            isCorrect = true; 
                        } else if (cleanedTranscript.includes(cleanedAnswer) || cleanedAnswer.includes(cleanedTranscript)) {
                            // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏û‡∏π‡∏î‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏¢‡∏≤‡∏ß ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô (‡∏≠‡∏ô‡∏∏‡πÇ‡∏•‡∏°)
                             isCorrect = true; 
                        } else {
                             isCorrect = false; 
                        }
                        
                        this.updateDebugInfo(`D: ${distance}, T: ${finalTolerance}`);
                    }

                    if(isCorrect) {
                        this.quizSession.lastRecordingBlob = blob;
                    }
                    this.runCardSequence(q, 'feedback', { isCorrect, transcript });
                } 
                else if (this.quizSession.currentState === 'AWAITING_LEVEL') {
                    this.showAlert(`‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô‡∏ß‡πà‡∏≤: "${transcript}"`, 'info');
                    const levelMap = { '‡∏´‡∏ô‡∏∂‡πà‡∏á': 1, 'one': 1, '‡∏™‡∏≠‡∏á': 2, 'two': 2, '‡∏™‡∏≤‡∏°': 3, 'three': 3, '‡∏™‡∏µ‡πà': 4, 'four': 4, '‡∏´‡πâ‡∏≤': 5, 'five': 5 };
                    let foundLevel = null;
                    const cleanTranscript = transcript.toLowerCase().trim();
                    const digitMatch = cleanTranscript.match(/[1-5]/);
                    if (digitMatch) {
                        foundLevel = parseInt(digitMatch[0], 10);
                    } else {
                        for (const key in levelMap) {
                            const wordRegex = new RegExp(`\\b${key}\\b`);
                            if (wordRegex.test(cleanTranscript)) {
                                foundLevel = levelMap[key];
                                break;
                            }
                        }
                    }
                    if (foundLevel) {
                        this.setReviewByLevel(foundLevel);
                    } else {
                        SpeechService.speak('‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏±‡∏ö', 'th-TH', () => {
                            this.quizSession.currentState = 'AWAITING_LEVEL';
                            const micIcon = document.querySelector('#quiz-area .bi-mic-fill');
                            if (micIcon) micIcon.classList.add('mic-listening');
                            const statusText = document.getElementById('status-text');
                            if(statusText) statusText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á...';
                            SpeechService.listen('th-TH');
                        });
                    }
                }
            },

            handleSpeechEnd() {
                SpeechService.isListening = false;
                const micIcon = document.querySelector('#quiz-area .bi-mic-fill');
                if (micIcon) mic.classList.remove('mic-listening');
            },
            
            async showRecordingHistory(wordId, wordQ) {
                const body = document.getElementById('history-modal-body');
                document.getElementById('history-modal-title').textContent = `‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á: ${wordQ}`;
                body.innerHTML = '<div class="text-center"><div class="spinner-border"></div></div>';
                const modal = new bootstrap.Modal(document.getElementById('historyModal'));
                modal.show();
                const recordings = await IndexedDBService.getRecordingsForWord(wordId);
                if (recordings.length === 0) { body.innerHTML = '<p class="text-center text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏î‡πÑ‡∏ß‡πâ</p>'; } 
                else if (recordings.length === 1) { const url = URL.createObjectURL(recordings[0].audioBlob); body.innerHTML = `<h5 class="mb-3">‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ó‡∏µ‡πà‡∏°‡∏µ</h5><p>‡∏≠‡∏±‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${recordings[0].timestamp.toLocaleString('th-TH')}</p><audio controls src="${url}" class="w-100"></audio>`; } 
                else {
                    const first = recordings[0], last = recordings[recordings.length - 1];
                    const firstUrl = URL.createObjectURL(first.audioBlob), lastUrl = URL.createObjectURL(last.audioBlob);
                    body.innerHTML = `<div class="row"><div class="col-md-6 mb-3 mb-md-0"><div class="card h-100"><div class="card-header"><h5><i class="bi bi-skip-start-circle"></i> ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å</h5></div><div class="card-body"><p><small>‡∏≠‡∏±‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${first.timestamp.toLocaleString('th-TH')}</small></p><audio controls class="w-100" src="${firstUrl}"></audio></div></div></div><div class="col-md-6"><div class="card h-100"><div class="card-header"><h5><i class="bi bi-check-circle"></i> ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h5></div><div class="card-body"><p><small>‡∏≠‡∏±‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${last.timestamp.toLocaleString('th-TH')}</small></p><audio controls class="w-100" src="${lastUrl}"></audio></div></div></div></div>`;
                }
            },
            
            async setReviewByLevel(level) {
                this.quizSession.currentState = null;
                const q = this.quizSession.currentQuestion;
                if (!q) return;
                const quizArea = document.getElementById('quiz-area');
                quizArea.innerHTML = `<div class="my-4 p-3"><p class="fs-5 text-muted">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Level ${level} ‡πÅ‡∏•‡πâ‡∏ß...</p><div class="spinner-border my-3" role="status"></div></div>`;
                if (this.quizSession.lastRecordingBlob) {
                    try { await IndexedDBService.addRecording(q.id, this.quizSession.lastRecordingBlob); } 
                    catch (err) { this.showAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ', 'danger'); }
                }
                const nextReviewDate = new Date();
                const minutesToAdd = this.LEVEL_TO_MINUTES_MAP[level] || 1;
                if (minutesToAdd < 1) {
                    nextReviewDate.setSeconds(nextReviewDate.getSeconds() + minutesToAdd * 60);
                } else {
                    nextReviewDate.setMinutes(nextReviewDate.getMinutes() + minutesToAdd);
                }
                await LocalStorageService.updateQuestion(q.id, { srs_level: level, next_review_date: nextReviewDate });
                const qIndex = this.allUserQuestions.findIndex(item => item.id === q.id);
                if (qIndex > -1) this.allUserQuestions[qIndex] = {...this.allUserQuestions[qIndex], srs_level: level, next_review_date: nextReviewDate};
                setTimeout(() => this.nextCard(), 1000);
            },
            
            startDueItemsCheck() {
                this.stopDueItemsCheck();
                this.dueCheckInterval = setInterval(() => {
                    const isOnMainMenu = !!document.querySelector('#template-main-menu');
                    if (!isOnMainMenu || document.body.classList.contains('modal-open') || this.quizSession.currentState) return;
                    const now = new Date();
                    const dueCount = this.allUserQuestions.filter(q => q.next_review_date <= now).length;
                    const toastEl = document.getElementById('due-toast');
                    const toast = bootstrap.Toast.getOrCreateInstance(toastEl);
                    if (dueCount > 0) {
                        document.getElementById('due-toast-message').textContent = `‡∏°‡∏µ ${dueCount} ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ñ‡∏∂‡∏á‡∏£‡∏≠‡∏ö‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß!`;
                        document.getElementById('start-due-toast-btn').onclick = () => {
                            toast.hide();
                            this.startSession({ category: 'due' });
                        };
                        toast.show();
                    } else {
                        toast.hide();
                    }
                }, 30000);
            },

            stopDueItemsCheck() {
                if (this.dueCheckInterval) {
                    clearInterval(this.dueCheckInterval);
                }
            },

            startActiveQuizDueCheck() {
                this.stopActiveQuizDueCheck();
                this.activeQuizInterval = setInterval(async () => {
                    const now = new Date();
                    const allQuestions = await LocalStorageService.getQuestions();
                    
                    const existingIds = new Set([
                        ...this.quizSession.dueQuestions.map(q => q.id),
                        this.quizSession.currentQuestion?.id
                    ]);

                    const newlyDueItems = allQuestions.filter(q => 
                        q.next_review_date <= now && !existingIds.has(q.id)
                    );

                    if (newlyDueItems.length > 0) {
                        this.showAlert(`${newlyDueItems.length} ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ñ‡∏∂‡∏á‡∏£‡∏≠‡∏ö‡∏ó‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏ó‡∏£‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß...`, 'info');
                        this.quizSession.dueQuestions.unshift(...newlyDueItems);
                        
                        for(const item of newlyDueItems) {
                            const qIndex = this.allUserQuestions.findIndex(q => q.id === item.id);
                            if (qIndex > -1) {
                                this.allUserQuestions[qIndex].next_review_date = new Date('2099-01-01');
                            }
                        }
                        await LocalStorageService.saveQuestions(this.allUserQuestions);
                        this.updateDebugInfo();
                    }
                }, 5000); 
            },

            stopActiveQuizDueCheck() {
                if (this.activeQuizInterval) {
                    clearInterval(this.activeQuizInterval);
                    this.activeQuizInterval = null;
                }
            },

            updateDebugInfo(extraInfo = '') {
                const debugContainer = document.getElementById('debug-info');
                if (!debugContainer) return;

                const currentQ = this.quizSession.currentQuestion;
                const queue = this.quizSession.dueQuestions;

                if (!currentQ && (!queue || queue.length === 0)) {
                    if (currentQ === null && queue && queue.length > 0) {
                    } else {
                        debugContainer.innerHTML = 'Session End';
                        return;
                    }
                }

                const currentIdShort = currentQ ? currentQ.id.toString().slice(-4) : 'N/A';
                
                let nextIdShort = 'N/A';
                let remainingQueueStr = '[]';

                if (queue && queue.length > 0) {
                    nextIdShort = queue[0].id.toString().slice(-4); 
                    if (queue.length > 1) {
                        remainingQueueStr = `[${queue.slice(1, 10).map(q => q.id.toString().slice(-4)).join(', ')}]`;
                    }
                }

                debugContainer.innerHTML = `
                    <p class="mb-1"><strong>Current ID:</strong> ${currentIdShort}</p>
                    <p class="mb-1"><strong>Next ID:</strong> ${nextIdShort}</p>
                    <p class="mb-0"><strong>Queue:</strong> ${remainingQueueStr}</p>
                    <p class="mb-0 text-danger">${extraInfo}</p>
                `;
            },

            showAlert(msg, type = 'success') {
                const c = document.getElementById('alert-container');
                const el = document.createElement('div');
                el.className = `alert alert-${type} alert-dismissible fade show`;
                el.innerHTML = `${msg}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
                c.appendChild(el);
                setTimeout(() => bootstrap.Alert.getOrCreateInstance(el).close(), 3000);
            }
        };

        // Start App
        document.addEventListener('DOMContentLoaded', () => {
            App.init();
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
