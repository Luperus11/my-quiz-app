<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เว็บทบทวนคำศัพท์</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f0f2f5; }
        .container { max-width: 700px; }
        .card { border: none; border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        #alert-container { position: fixed; top: 1rem; right: 1rem; z-index: 1055; min-width: 250px; }
        .hidden { display: none !important; }
        .mic-listening, .mic-recording { color: #fff; background-color: #dc3545; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); } }
    </style>
</head>
<body>
    <div class="container my-4">
        <div id="login-section">
            <div class="card p-4">
                <h2 class="text-center mb-4">เข้าสู่ระบบ</h2>
                <div id="login-alert" class="alert alert-danger hidden" role="alert"></div>
                <div class="mb-3"><label for="login-email" class="form-label">อีเมล</label><input type="email" id="login-email" class="form-control" required></div>
                <div class="mb-3"><label for="login-password" class="form-label">รหัสผ่าน</label><input type="password" id="login-password" class="form-control" required></div>
                <div class="d-grid gap-2"><button type="button" id="login-btn" class="btn btn-primary">เข้าสู่ระบบ</button></div>
                <p class="text-center mt-3 mb-0">ยังไม่มีบัญชี? <a href="#" id="go-to-register">สมัครสมาชิกที่นี่</a></p>
            </div>
        </div>
        <div id="register-section" class="hidden">
            <div class="card p-4">
                <h2 class="text-center mb-4">สมัครสมาชิกใหม่</h2>
                <div id="register-alert" class="alert alert-danger hidden" role="alert"></div>
                <div class="mb-3"><label for="register-email" class="form-label">อีเมล</label><input type="email" id="register-email" class="form-control" required></div>
                <div class="mb-3"><label for="register-password" class="form-label">รหัสผ่าน (6 ตัวอักษรขึ้นไป)</label><input type="password" id="register-password" class="form-control" required></div>
                <div class="d-grid gap-2"><button type="button" id="register-btn" class="btn btn-success">ยืนยันการสมัคร</button></div>
                <p class="text-center mt-3 mb-0">มีบัญชีอยู่แล้ว? <a href="#" id="go-to-login">กลับไปหน้าเข้าสู่ระบบ</a></p>
            </div>
        </div>
        
        <main id="app-root" class="hidden"></main>
    </div>

    <div id="alert-container"></div>
    
    <div class="modal fade" id="historyModal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="history-modal-title">ประวัติ</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="history-modal-body"></div></div></div></div>
    <div class="modal fade" id="startSessionModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">เริ่มรอบใหม่</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="mb-3"><label class="form-label">เลือกโหมด</label><div class="form-check"><input class="form-check-input" type="radio" name="sessionMode" id="mode-listen" value="listen" checked><label class="form-check-label" for="mode-listen">โหมดฟัง (ทบทวนคำศัพท์)</label></div><div class="form-check"><input class="form-check-input" type="radio" name="sessionMode" id="mode-quiz" value="quiz"><label class="form-check-label" for="mode-quiz">โหมดทดสอบการพูด (ตอบถูก/ผิด)</label></div></div><div class="mb-3"><label for="category-select" class="form-label">เลือกชุดคำศัพท์</label><select id="category-select" class="form-select"><option value="all">ทบทวนทั้งหมด</option><option value="due">เฉพาะที่ถึงรอบทวน (วันนี้)</option></select></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button><button type="button" id="confirm-start-btn" class="btn btn-primary">เริ่มต้น</button></div></div></div></div>
    <template id="template-main-menu"><div class="card"><div class="card-body"><div class="d-flex justify-content-between align-items-center mb-4"><h5 class="mb-0" id="welcome-message"></h5><button id="logout-btn" class="btn btn-sm btn-outline-danger">ออกจากระบบ</button></div><div class="text-center p-2"><h1 class="text-primary mb-3">เว็บทบทวนคำศัพท์</h1><p class="text-muted mb-4">เลือกเมนูเพื่อเริ่มต้น</p><div class="d-grid gap-3"><button id="start-new-btn" class="btn btn-primary btn-lg"><i class="bi bi-stars"></i> เริ่มรอบใหม่</button><button id="manage-btn" class="btn btn-outline-secondary"><i class="bi bi-gear-fill"></i> จัดการข้อมูล</button><button id="dashboard-btn" class="btn btn-outline-info"><i class="bi bi-graph-up"></i> ดูสถิติ</button></div></div></div></div></template>
    <template id="template-test"><div class="card"><div class="card-header bg-primary text-white d-flex justify-content-between align-items-center"><h3 id="session-title" class="fs-5 mb-0"></h3><div id="session-stats"><span id="due-count-badge" class="badge bg-light text-dark"></span></div></div><div class="card-body text-center" id="quiz-area"></div></div></template>
    <template id="template-manage"><button id="back-to-menu-btn" class="btn btn-secondary mb-3 w-100"><i class="bi bi-arrow-left"></i> กลับไปเมนูหลัก</button><div class="card mb-4"><div class="card-header bg-info text-white"><h5><i class="bi bi-plus-circle-fill"></i> เพิ่มคำศัพท์ใหม่</h5></div><div class="card-body"><form id="add-form"><div class="mb-3"><label for="new-question" class="form-label">คำศัพท์ภาษาอังกฤษ</label><input type="text" id="new-question" class="form-control" required></div><div class="mb-3"><label for="new-answer" class="form-label">คำแปลภาษาไทย</label><input type="text" id="new-answer" class="form-control" required></div><div class="mb-3"><label for="new-category" class="form-label">หมวดหมู่</label><input type="text" id="new-category" class="form-control" placeholder="เช่น วิศวกรรมไฟฟ้า" required></div><button type="submit" class="btn btn-success w-100">เพิ่มคำศัพท์</button></form></div></div><div class="card"><div class="card-header bg-secondary text-white"><h5><i class="bi bi-card-list"></i> คลังคำศัพท์ทั้งหมด</h5></div><div class="card-body"><div id="questions-list" class="table-responsive"></div></div></div></template>
    <template id="template-dashboard"><button id="back-to-menu-btn" class="btn btn-secondary mb-3 w-100"><i class="bi bi-arrow-left"></i> กลับไปเมนูหลัก</button><div class="card mb-4"><div class="card-header bg-primary text-white"><h5><i class="bi bi-speedometer2"></i> แดชบอร์ดสรุปผล</h5></div><div class="card-body"><div class="row text-center mb-4"><div class="col"><h4 class="mb-0 text-primary" id="total-questions">0</h4><small class="text-muted">คำศัพท์ทั้งหมด</small></div><div class="col"><h4 class="mb-0 text-warning" id="due-for-review">0</h4><small class="text-muted">ถึงรอบทวน</small></div></div><hr><h6 class="mb-3">สัดส่วนคำศัพท์ตามหมวดหมู่</h6><div style="position: relative; height:300px; width:100%"><canvas id="categoryChart"></canvas></div><hr><h6 class="mb-3">ผลการตอบถูก/ผิด ย้อนหลัง 7 วัน</h6><div style="position: relative; height:300px; width:100%"><canvas id="dailyResultChart"></canvas></div></div></div></template>

    <script type="module">
        // Import functions from Firebase (No changes)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, getDocs, addDoc, deleteDoc, updateDoc, Timestamp, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Firebase configuration (No changes)
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyDMmUxdlbAsjXdVr8JXfFV6zqVL2am9bwM",
            authDomain: "spaced-repetition-system-7ce8a.firebaseapp.com",
            projectId: "spaced-repetition-system-7ce8a",
            storageBucket: "spaced-repetition-system-7ce8a.firebasestorage.app",
            messagingSenderId: "668763983651",
            appId: "1:668763983651:web:3cc3df1c61d0165c764696",
            measurementId: "G-MPVL49Y2T4"
            };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements, Global Variables (No changes)
            const loginSection = document.getElementById('login-section');
            const registerSection = document.getElementById('register-section');
            const appRoot = document.getElementById('app-root');
            const loginBtn = document.getElementById('login-btn');
            const loginEmailInput = document.getElementById('login-email');
            const loginPasswordInput = document.getElementById('login-password');
            const loginAlert = document.getElementById('login-alert');
            const goToRegisterLink = document.getElementById('go-to-register');
            const registerBtn = document.getElementById('register-btn');
            const registerEmailInput = document.getElementById('register-email');
            const registerPasswordInput = document.getElementById('register-password');
            const registerAlert = document.getElementById('register-alert');
            const goToLoginLink = document.getElementById('go-to-login');
            let currentUser = null;
            let allUserQuestions = [];
            const LEVEL_TO_DAYS_MAP = { 1: 1, 2: 3, 3: 7, 4: 15, 5: 30 };
            const LEVEL_DESCRIPTIONS = { 1: "จำไม่ได้เลย", 2: "ยาก", 3: "พอได้", 4: "ง่าย", 5: "ง่ายมาก" };
            let QuizSession = {};
            let historyModalInstance = null, startSessionModalInstance = null;
            let categoryChartInstance = null, dailyResultChartInstance = null;
            const showApp = () => { loginSection.classList.add('hidden'); registerSection.classList.add('hidden'); appRoot.classList.remove('hidden'); };
            const showLoginScreen = () => { registerSection.classList.add('hidden'); appRoot.classList.add('hidden'); loginSection.classList.remove('hidden'); };
            const showRegisterScreen = () => { loginSection.classList.add('hidden'); appRoot.classList.add('hidden'); registerSection.classList.remove('hidden'); };
            const showLoginError = (message) => { loginAlert.textContent = message; loginAlert.classList.remove('hidden'); };
            const showRegisterError = (message) => { registerAlert.textContent = message; registerAlert.classList.remove('hidden'); };
            const showAlert = (msg, type = 'success') => { const c = document.getElementById('alert-container'); const el = document.createElement('div'); el.className = `alert alert-${type} alert-dismissible fade show`; el.innerHTML = `${msg}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`; c.appendChild(el); setTimeout(() => el.remove(), 3000); };
            const FirebaseService = { getQuestions: async (userId) => { const qCollection = collection(db, 'users', userId, 'words'); const snapshot = await getDocs(qCollection); return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); }, addQuestion: (userId, data) => addDoc(collection(db, 'users', userId, 'words'), data), deleteQuestion: (userId, wordId) => deleteDoc(doc(db, 'users',userId, 'words', wordId)), updateQuestion: (userId, wordId, data) => updateDoc(doc(db, 'users', userId, 'words', wordId), data), addResult: (userId, data) => addDoc(collection(db, 'users', userId, 'results'), data), getResults: async (userId) => { const rCollection = collection(db, 'users', userId, 'results'); const snapshot = await getDocs(rCollection); return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); } };
            const SpeechService = {
                recognition: null, isListening: false,
                init: () => {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    if (SpeechRecognition) {
                        SpeechService.recognition = new SpeechRecognition();
                        SpeechService.recognition.continuous = false;
                        SpeechService.recognition.interimResults = false;
                        SpeechService.recognition.lang = 'th-TH';
                        SpeechService.recognition.onresult = (event) => {
                            const transcript = event.results[0][0].transcript.trim();
                            App.handleSpeechInput(transcript);
                        };
                        SpeechService.recognition.onerror = (event) => { showAlert(`เกิดข้อผิดพลาดในการรับเสียง: ${event.error}`, 'danger'); };
                    }
                },
                speak: (text, lang, onEndCallback = null) => {
                    if ('speechSynthesis' in window) {
                        const utterance = new SpeechSynthesisUtterance(text);
                        utterance.lang = lang;
                        if (lang === 'th-TH') { utterance.rate = 0.8; } 
                        else { utterance.rate = 1.0; }
                        if (onEndCallback) { utterance.onend = onEndCallback; }
                        window.speechSynthesis.speak(utterance);
                    } else if (onEndCallback) { onEndCallback(); }
                },
                speakPair: (text1, lang1, text2, lang2) => {
                    if ('speechSynthesis' in window) window.speechSynthesis.cancel();
                    SpeechService.speak(text1, lang1, () => {
                        setTimeout(() => SpeechService.speak(text2, lang2), 400);
                    });
                },
                toggleListen: (btn, lang) => {
                    if (!SpeechService.recognition) { showAlert('เบราว์เซอร์ไม่รองรับการพูด', 'warning'); return; }
                    if (SpeechService.recognition.lang !== lang) SpeechService.recognition.lang = lang;
                    if (SpeechService.isListening) { SpeechService.recognition.stop(); return; }
                    SpeechService.recognition.start();
                    SpeechService.recognition.onstart = () => { SpeechService.isListening = true; btn.classList.add('mic-listening'); };
                    SpeechService.recognition.onend = () => { SpeechService.isListening = false; btn.classList.remove('mic-listening'); };
                }
            };
            const RecordingService = {
                mediaRecorder: null, audioChunks: [], isRecording: false, stream: null,
                startRecording: async (btn) => {
                    if (RecordingService.isRecording) return;
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) { showAlert('เบราว์เซอร์ไม่รองรับการอัดเสียง', 'danger'); return; }
                    try {
                        RecordingService.stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        RecordingService.mediaRecorder = new MediaRecorder(RecordingService.stream);
                        RecordingService.audioChunks = [];
                        RecordingService.mediaRecorder.ondataavailable = event => { RecordingService.audioChunks.push(event.data); };
                        RecordingService.mediaRecorder.start();
                        RecordingService.isRecording = true;
                        if (btn) btn.classList.add('mic-recording');
                    } catch (err) { showAlert('ไม่สามารถเข้าถึงไมโครโฟนได้', 'danger'); }
                },
                stopRecording: (btn) => {
                    return new Promise(resolve => {
                        if (!RecordingService.mediaRecorder || RecordingService.mediaRecorder.state === "inactive") { resolve(null); return; }
                        RecordingService.mediaRecorder.onstop = () => {
                            const audioBlob = new Blob(RecordingService.audioChunks, { type: 'audio/webm' });
                            if (RecordingService.stream) {
                                RecordingService.stream.getTracks().forEach(track => track.stop());
                                RecordingService.stream = null;
                            }
                            RecordingService.isRecording = false;
                            if (btn) btn.classList.remove('mic-recording');
                            resolve(audioBlob);
                        };
                        RecordingService.mediaRecorder.stop();
                    });
                }
            };
            const IndexedDBService = {
                db: null,
                init: () => {
                    return new Promise((resolve, reject) => {
                        if (IndexedDBService.db) { resolve(); return; }
                        const request = indexedDB.open('audioHistoryDB', 1);
                        request.onerror = event => { console.error("IndexedDB error:", event.target.error); reject("Database error"); };
                        request.onsuccess = event => { IndexedDBService.db = event.target.result; resolve(); };
                        request.onupgradeneeded = event => {
                            const db = event.target.result;
                            db.createObjectStore('recordings', { keyPath: 'id', autoIncrement: true });
                        };
                    });
                },
                addRecording: (wordId, audioBlob) => {
                    return new Promise((resolve, reject) => {
                        const transaction = IndexedDBService.db.transaction(['recordings'], 'readwrite');
                        const store = transaction.objectStore('recordings');
                        const recording = { wordId: wordId, audioBlob: audioBlob, timestamp: new Date() };
                        const request = store.add(recording);
                        request.onsuccess = () => resolve();
                        request.onerror = event => reject(event.target.error);
                    });
                },
                getRecordingsForWord: (wordId) => {
                    return new Promise((resolve, reject) => {
                        const transaction = IndexedDBService.db.transaction(['recordings'], 'readonly');
                        const store = transaction.objectStore('recordings');
                        const recordings = [];
                        const request = store.openCursor();
                        request.onsuccess = event => {
                            const cursor = event.target.result;
                            if (cursor) {
                                if (cursor.value.wordId === wordId) { recordings.push(cursor.value); }
                                cursor.continue();
                            } else {
                                resolve(recordings.sort((a,b) => a.timestamp - b.timestamp)); // Sort Oldest to Newest
                            }
                        };
                        request.onerror = event => reject(event.target.error);
                    });
                }
            };
            
            onAuthStateChanged(auth, async (user) => { if (user) { currentUser = user; await IndexedDBService.init(); allUserQuestions = await FirebaseService.getQuestions(currentUser.uid); if (allUserQuestions.length === 0) { const initialQuestions = [ { question: 'Voltage', answer: 'แรงดันไฟฟ้า', category: 'วิศวกรรมไฟฟ้า' }, { question: 'Current', answer: 'กระแสไฟฟ้า', category: 'วิศวกรรมไฟฟ้า' }, { question: 'Resistance', answer: 'ความต้านทาน', category: 'วิศวกรรมไฟฟ้า' }, { question: 'Capacitor', answer: 'ตัวเก็บประจุ', category: 'วิศวกรรมไฟฟ้า' }, { question: 'Transistor', answer: 'ทรานซิสเตอร์', category: 'วิศวกรรมไฟฟ้า' }, { question: 'Semiconductor', answer: 'สารกึ่งตัวนำ', category: 'วิศวกรรมไฟฟ้า' }, { question: 'Generator', answer: 'เครื่องกำเนิดไฟฟ้า', category: 'วิศวกรรมไฟฟ้า' }, { question: 'Torque', answer: 'แรงบิด', category: 'วิศวกรรมเครื่องกล' }, { question: 'Velocity', answer: 'ความเร็ว', category: 'วิศวกรรมเครื่องกล' }, { question: 'Acceleration', answer: 'ความเร่ง', category: 'วิศวกรรมเครื่องกล' }, { question: 'Friction', answer: 'ความเสียดทาน', category: 'วิศวกรรมเครื่องกล' }, { question: 'Thermodynamics', answer: 'อุณหพลศาสตร์', category: 'วิศวกรรมเครื่องกล' }, { question: 'Viscosity', answer: 'ความหนืด', category: 'วิศวกรรมเครื่องกล' }, { question: 'Turbine', answer: 'กังหัน', category: 'วิศวกรรมเครื่องกล' }, { question: 'Foundation', answer: 'ฐานราก', category: 'วิศวกรรมโยธา' }, { question: 'Beam', answer: 'คาน', category: 'วิศวกรรมโยธا' }, { question: 'Column', answer: 'เสา', category: 'วิศวกรรมโยธา' }, { question: 'Tension', answer: 'แรงดึง', category: 'วิศวกรรมโยธา' }, { question: 'Compression', answer: 'แรงอัด', category: 'วิศวกรรมโยธา' }, { question: 'Concrete', answer: 'คอนกรีต', category: 'วิศวกรรมโยธา' }, { question: 'Infrastructure', answer: 'โครงสร้างพื้นฐาน', category: 'วิศวกรรมโยธา' }, { question: 'Catalyst', answer: 'ตัวเร่งปฏิกิริยา', category: 'วิศวกรรมเคมี' }, { question: 'Distillation', answer: 'การกลั่นลำดับส่วน', category: 'วิศวกรรมเคมี' }, { question: 'Molecule', answer: 'โมเลกุล', category: 'วิศวกรรมเคมี' }, { question: 'Polymer', answer: 'พอลิเมอร์', category: 'วิศวกรรมเคมี' }, { question: 'Reaction', answer: 'ปฏิกิริยา', category: 'วิศวกรรมเคมี' }, { question: 'Solvent', answer: 'ตัวทำละลาย', category: 'วิศวกรรมเคมี' }, { question: 'Algorithm', answer: 'อัลกอริทึม', category: 'วิศวกรรมคอมพิวเตอร์' }, { question: 'Database', answer: 'ฐานข้อมูล', category: 'วิศวกรรมคอมพิวเตอร์' }, { question: 'Firewall', answer: 'ไฟร์วอลล์', category: 'วิศวกรรมคอมพิวเตอร์' }, { question: 'Encryption', answer: 'การเข้ารหัส', category: 'วิศวกรรมคอมพิวเตอร์' }, { question: 'Software', answer: 'ซอฟต์แวร์', category: 'วิศวกรรมคอมพิวเตอร์' }, { question: 'Hardware', answer: 'ฮาร์ดแวร์', category: 'วิศวกรรมคอมพิวเตอร์' }, { question: 'Network', answer: 'เครือข่าย', category: 'วิศวกรรมคอมพิวเตอร์' }, { question: 'Compiler', answer: 'คอมไพเลอร์', category: 'วิศวกรรมคอมพิวเตอร์' } ]; for (const q of initialQuestions) { await FirebaseService.addQuestion(currentUser.uid, { ...q, srs_level: 0, next_review_date: Timestamp.now() }); } allUserQuestions = await FirebaseService.getQuestions(currentUser.uid); } SpeechService.init(); showApp(); UI.renderMainMenu(); } else { showLoginScreen(); } });
            goToRegisterLink.addEventListener('click', (e) => { e.preventDefault(); showRegisterScreen(); });
            goToLoginLink.addEventListener('click', (e) => { e.preventDefault(); showLoginScreen(); });
            loginBtn.addEventListener('click', () => signInWithEmailAndPassword(auth, loginEmailInput.value, loginPasswordInput.value).catch(err => showLoginError("อีเมลหรือรหัสผ่านไม่ถูกต้อง")));
            registerBtn.addEventListener('click', () => createUserWithEmailAndPassword(auth, registerEmailInput.value, registerPasswordInput.value).then(() => { showAlert('สมัครสมาชิกสำเร็จ! กรุณากลับไปหน้าเข้าสู่ระบบ', 'success'); showLoginScreen(); }).catch(err => { if (err.code === 'auth/email-already-in-use') { showRegisterError("อีเมลนี้ถูกใช้งานแล้ว"); } else if (err.code === 'auth/weak-password') { showRegisterError("รหัสผ่านต้องมีความยาว 6 ตัวอักษรขึ้นไป"); } else { showRegisterError(`เกิดข้อผิดพลาด: ${err.message}`); } }));

            const UI = {
                renderMainMenu: () => { appRoot.innerHTML = document.getElementById('template-main-menu').innerHTML; document.getElementById('welcome-message').textContent = `ยินดีต้อนรับ, ${currentUser.email}`; document.getElementById('logout-btn').addEventListener('click', () => signOut(auth)); document.getElementById('start-new-btn').addEventListener('click', UI.showStartSessionModal); document.getElementById('manage-btn').addEventListener('click', UI.renderManagePage); document.getElementById('dashboard-btn').addEventListener('click', UI.renderDashboardPage); },
                renderManagePage: async () => {
                    appRoot.innerHTML = document.getElementById('template-manage').innerHTML;
                    document.getElementById('back-to-menu-btn').addEventListener('click', UI.renderMainMenu);
                    const listContainer = document.getElementById('questions-list');
                    listContainer.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div></div>';
                    allUserQuestions = await FirebaseService.getQuestions(currentUser.uid);
                    if (allUserQuestions.length === 0) { listContainer.innerHTML = '<p class="text-center text-muted">ยังไม่มีคำศัพท์</p>'; } 
                    else {
                        const now = new Date(); now.setHours(0,0,0,0);
                        let tableHTML = `<table class="table table-striped table-hover"><thead><tr><th>คำศัพท์ / หมวดหมู่</th><th>สถานะ</th><th class="text-end">จัดการ</th></tr></thead><tbody>`;
                        for(const q of allUserQuestions.sort((a,b)=>a.question.localeCompare(b.question))) {
                            const nr = q.next_review_date.toDate();
                            const due = nr <= now;
                            const s = due ? `<span class="badge bg-warning">ถึงรอบทวน</span>` : `<span class="badge bg-secondary">อีก ${Math.ceil((nr - now) / 864e5)} วัน</span>`;
                            tableHTML += `<tr><td>${q.question}<br><small class="text-muted">${q.answer}</small><br><small class="text-info">${q.category}</small></td><td><span class="badge bg-info">Lv. ${q.srs_level}</span> ${s}</td><td class="text-end"><button class="btn btn-sm btn-info recording-history-btn" data-word-id="${q.id}" data-word-q="${q.question}"><i class="bi bi-clock-history"></i></button> <button class="btn btn-sm btn-danger delete-btn" data-id="${q.id}">ลบ</button></td></tr>`;
                        }
                        tableHTML += `</tbody></table>`;
                        listContainer.innerHTML = tableHTML;
                    }
                    document.getElementById('add-form').addEventListener('submit', async (e) => { e.preventDefault(); const form = e.target; await FirebaseService.addQuestion(currentUser.uid, { question: form.elements['new-question'].value, answer: form.elements['new-answer'].value, category: form.elements['new-category'].value, srs_level: 0, next_review_date: Timestamp.now() }); showAlert('เพิ่มคำศัพท์สำเร็จ!'); UI.renderManagePage(); });
                    listContainer.querySelectorAll('.delete-btn').forEach(b => b.addEventListener('click', async (e) => { if (confirm('ยืนยันการลบ?')) { await FirebaseService.deleteQuestion(currentUser.uid, e.target.dataset.id); showAlert('ลบคำศัพท์แล้ว', 'warning'); UI.renderManagePage(); } }));
                    listContainer.querySelectorAll('.recording-history-btn').forEach(b => b.addEventListener('click', (e) => { UI.showRecordingHistory(e.currentTarget.dataset.wordId, e.currentTarget.dataset.wordQ); }));
                },
                renderDashboardPage: async () => { appRoot.innerHTML = document.getElementById('template-dashboard').innerHTML; document.getElementById('back-to-menu-btn').addEventListener('click', UI.renderMainMenu); const allResults = await FirebaseService.getResults(currentUser.uid); document.getElementById('total-questions').textContent = allUserQuestions.length; const now = new Date(); now.setHours(0,0,0,0); const dueCount = allUserQuestions.filter(q => q.next_review_date.toDate() <= now).length; document.getElementById('due-for-review').textContent = dueCount; const categoryCounts = allUserQuestions.reduce((acc, q) => { acc[q.category] = (acc[q.category] || 0) + 1; return acc; }, {}); if(categoryChartInstance) categoryChartInstance.destroy(); categoryChartInstance = new Chart(document.getElementById('categoryChart').getContext('2d'), { type: 'pie', data: { labels: Object.keys(categoryCounts), datasets: [{ data: Object.values(categoryCounts), backgroundColor: Object.keys(categoryCounts).map((_,i)=>`hsl(${i*60},70%,70%)`), hoverOffset: 4 }] }, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'right'}}} }); const dailyResults = {}; for (let i = 6; i >= 0; i--) { const d = new Date(now); d.setDate(now.getDate() - i); dailyResults[d.toLocaleDateString('th-TH')] = { correct: 0, wrong: 0 }; } allResults.forEach(r => { const resultDate = r.timestamp.toDate().toLocaleDateString('th-TH'); if (dailyResults[resultDate]) { r.isCorrect ? dailyResults[resultDate].correct++ : dailyResults[resultDate].wrong++; } }); if(dailyResultChartInstance) dailyResultChartInstance.destroy(); dailyResultChartInstance = new Chart(document.getElementById('dailyResultChart').getContext('2d'), { type: 'bar', data: { labels: Object.keys(dailyResults), datasets: [{ label: 'ตอบถูก', data: Object.values(dailyResults).map(d=>d.correct), backgroundColor: 'rgba(75,192,192,0.6)' }, { label: 'ตอบผิด', data: Object.values(dailyResults).map(d=>d.wrong), backgroundColor: 'rgba(255,99,132,0.6)' }] }, options:{responsive:true, maintainAspectRatio:false, scales:{y:{beginAtZero:true, ticks:{stepSize:1}}}} }); },
                showStartSessionModal: () => {
                    const categorySelect = document.getElementById('category-select');
                    const dynamicOptions = categorySelect.querySelectorAll('option[data-dynamic]');
                    dynamicOptions.forEach(opt => opt.remove());
                    const categories = [...new Set(allUserQuestions.map(q => q.category))];
                    categories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat;
                        option.textContent = `เฉพาะหมวดหมู่: ${cat}`;
                        option.dataset.dynamic = true;
                        categorySelect.appendChild(option);
                    });
                    startSessionModalInstance = new bootstrap.Modal(document.getElementById('startSessionModal'));
                    startSessionModalInstance.show();
                    document.getElementById('confirm-start-btn').onclick = () => {
                        startSessionModalInstance.hide();
                        const sessionOptions = {
                            mode: document.querySelector('input[name="sessionMode"]:checked').value,
                            category: categorySelect.value,
                        };
                        App.startSession(sessionOptions);
                    };
                },
                renderTestPage: () => { 
                    appRoot.innerHTML = document.getElementById('template-test').innerHTML;
                    const modeMap = { 'listen': 'โหมดฟัง', 'quiz': 'โหมดทดสอบการพูด' };
                    document.getElementById('session-title').innerHTML = `<i class="bi bi-earbuds"></i> ${modeMap[QuizSession.mode]}`;
                    App.nextCard(); 
                },
                
                displayListenCard: (q) => {
                    const qa = document.getElementById('quiz-area');
                    let cardHTML = `<div class="d-flex justify-content-between mb-2">
                                        <button class="btn btn-sm btn-outline-secondary" id="back-to-menu-quiz-btn"><i class="bi bi-arrow-left"></i> กลับไปเมนูหลัก</button>
                                        <button id="skip-btn" class="btn btn-sm btn-outline-warning">ข้ามข้อนี้ <i class="bi bi-arrow-right-short"></i></button>
                                    </div>
                                    <div class="my-4 p-3 border rounded bg-light">
                                        <p class="fs-4"><strong>${q.question}</strong></p>
                                        <p class="fs-5 text-muted">${q.answer}</p>
                                    </div>
                                    <hr>
                                    <p class="fs-5 mt-4">เลือก Level หรือออกคำสั่ง</p>
                                    <div class="d-flex justify-content-center align-items-center gap-3 mt-3">
                                        <div>
                                            <button id="command-btn" class="btn btn-lg btn-secondary rounded-circle" style="width: 80px; height: 80px;"><i class="bi bi-chat-dots-fill fs-2"></i></button>
                                            <p class="mt-2 text-muted small">ออกคำสั่งเสียง</p>
                                        </div>
                                    </div>
                                    <div class="mt-4">
                                        <p class="small text-muted">หรือคลิกเพื่อเลือก Level</p>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-outline-secondary level-btn" data-level="1">1</button>
                                            <button type="button" class="btn btn-outline-secondary level-btn" data-level="2">2</button>
                                            <button type="button" class="btn btn-outline-secondary level-btn" data-level="3">3</button>
                                            <button type="button" class="btn btn-outline-secondary level-btn" data-level="4">4</button>
                                            <button type="button" class="btn btn-outline-secondary level-btn" data-level="5">5</button>
                                        </div>
                                    </div>`;
                    qa.innerHTML = cardHTML;
                    document.getElementById('back-to-menu-quiz-btn').addEventListener('click', UI.renderMainMenu);
                    document.getElementById('skip-btn').addEventListener('click', () => App.skipCard());
                    document.getElementById('command-btn').addEventListener('click', () => SpeechService.toggleListen(document.getElementById('command-btn'), 'th-TH'));
                    qa.querySelectorAll('.level-btn').forEach(btn => {
                        btn.addEventListener('click', () => App.setReviewByLevel(parseInt(btn.dataset.level)));
                    });
                    SpeechService.speakPair(q.question, 'en-US', q.answer, 'th-TH');
                },

                displaySpeakingQuizCard: (q) => {
                    const qa = document.getElementById('quiz-area');
                    const promptText = q.answer;
                    const promptLang = 'th-TH';
                    const answerText = q.question;

                    let cardHTML = `
                        <div class="d-flex justify-content-between mb-2">
                            <button class="btn btn-sm btn-outline-secondary" id="back-to-menu-quiz-btn"><i class="bi bi-arrow-left"></i> กลับไปเมนูหลัก</button>
                            <button id="skip-btn" class="btn btn-sm btn-outline-warning">ข้ามข้อนี้ <i class="bi bi-arrow-right-short"></i></button>
                        </div>
                        <div class="my-4 p-3">
                            <p class="fs-5 text-muted">คำศัพท์คำนี้คืออะไร?</p>
                            <h2 class="display-5">${promptText}</h2>
                            <p id="correct-answer-display" class="fs-4 text-primary hidden mt-3"><strong>${answerText}</strong></p>
                        </div>
                        <div class="text-center mb-3">
                            <button id="speak-prompt-btn" class="btn btn-sm btn-outline-secondary me-2"><i class="bi bi-volume-up-fill"></i> ฟังคำใบ้</button>
                            <button id="show-answer-btn" class="btn btn-sm btn-outline-info"><i class="bi bi-eye-fill"></i> เฉลย</button>
                        </div>
                        <hr>
                        <p class="fs-5 mt-4">กดปุ่มไมโครโฟนค้างไว้เพื่อพูดคำตอบ</p>
                        <div class="d-flex justify-content-center align-items-center gap-3 mt-3">
                            <button id="answer-mic-btn" class="btn btn-lg btn-danger rounded-circle" style="width: 80px; height: 80px;"><i class="bi bi-mic-fill fs-2"></i></button>
                        </div>`;
                    
                    qa.innerHTML = cardHTML;
                    document.getElementById('back-to-menu-quiz-btn').addEventListener('click', UI.renderMainMenu);
                    document.getElementById('skip-btn').addEventListener('click', () => App.skipCard());
                    document.getElementById('speak-prompt-btn').addEventListener('click', () => SpeechService.speak(promptText, promptLang));
                    document.getElementById('show-answer-btn').addEventListener('click', () => {
                        document.getElementById('correct-answer-display').classList.remove('hidden');
                    });
                    
                    const micBtn = document.getElementById('answer-mic-btn');
                    micBtn.addEventListener('mousedown', () => App.handleQuizAnswer('start', micBtn));
                    micBtn.addEventListener('mouseup', () => App.handleQuizAnswer('stop', micBtn));
                    micBtn.addEventListener('touchstart', (e) => { e.preventDefault(); App.handleQuizAnswer('start', micBtn); });
                    micBtn.addEventListener('touchend', (e) => { e.preventDefault(); App.handleQuizAnswer('stop', micBtn); });

                    SpeechService.speak(promptText, promptLang);
                },
                
                showQuizResult: (isCorrect, transcript) => {
                    const q = QuizSession.currentQuestion;
                    const qa = document.getElementById('quiz-area');
                    const resultText = isCorrect ? "ถูกต้อง!" : "ยังไม่ถูกต้อง";
                    const resultClass = isCorrect ? "text-success" : "text-danger";

                    let resultHTML = `<div class="my-4 p-3">
                                        <h2 class="${resultClass}">${resultText}</h2>
                                        <p class="text-muted">คุณตอบว่า (ระบบได้ยิน): <strong class="text-dark">"${transcript || 'ไม่ได้ยินเสียง'}"</strong></p>
                                        <hr>
                                        <p class="mt-3">คำตอบที่ถูกต้องคือ:</p>
                                        <h3 class="display-6 text-primary">${q.question}</h3>
                                        <p class="mt-4 text-muted">กำลังไปขั้นตอนต่อไป...</p>
                                     </div>`;
                    qa.innerHTML = resultHTML;

                    SpeechService.speak(q.question, 'en-US');

                    setTimeout(() => {
                        if(isCorrect) {
                            QuizSession.isAwaitingLevel = true;
                            UI.showLevelSelection();
                        } else {
                            UI.displaySpeakingQuizCard(q);
                        }
                    }, 3000); 
                },

                showLevelSelection: () => {
                    const qa = document.getElementById('quiz-area');
                    let optionsHTML = `<h4 class="mb-3">คุณจำคำนี้ได้ดีแค่ไหน?</h4><div class="text-start mx-auto" style="max-width: 300px;">`;
                    for(const level in LEVEL_DESCRIPTIONS){
                        optionsHTML += `<p><strong>เลเวล ${level}:</strong> ${LEVEL_DESCRIPTIONS[level]}</p>`;
                    }
                    optionsHTML += `</div><div class="mt-4"><p class="small text-muted">คลิกหรือพูดเพื่อเลือก Level</p><div class="btn-group" role="group"><button type="button" class="btn btn-outline-secondary level-btn" data-level="1">1</button><button type="button" class="btn btn-outline-secondary level-btn" data-level="2">2</button><button type="button" class="btn btn-outline-secondary level-btn" data-level="3">3</button><button type="button" class="btn btn-outline-secondary level-btn" data-level="4">4</button><button type="button" class="btn btn-outline-secondary level-btn" data-level="5">5</button></div><button id="mic-btn" class="btn btn-secondary rounded-circle ms-3"><i class="bi bi-mic-fill"></i></button></div>`;
                    qa.innerHTML = optionsHTML;
                    const micBtn = document.getElementById('mic-btn');
                    micBtn.addEventListener('click', () => SpeechService.toggleListen(micBtn, 'th-TH'));
                    qa.querySelectorAll('.level-btn').forEach(btn => {
                        btn.addEventListener('click', () => App.setReviewByLevel(parseInt(btn.dataset.level)));
                    });
                },
                
                showRecordingHistory: async (wordId, wordQ) => {
                    const title = document.getElementById('history-modal-title');
                    const body = document.getElementById('history-modal-body');
                    title.textContent = `เปรียบเทียบเสียง: ${wordQ}`;
                    body.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div></div>';
                    historyModalInstance = new bootstrap.Modal(document.getElementById('historyModal'));
                    historyModalInstance.show();
                    try {
                        const recordings = await IndexedDBService.getRecordingsForWord(wordId);
                        if (recordings.length === 0) { body.innerHTML = '<p class="text-center text-muted">ยังไม่มีเสียงที่อัดไว้สำหรับคำนี้</p>'; } 
                        else if (recordings.length === 1) { const rec = recordings[0]; const audioUrl = URL.createObjectURL(rec.audioBlob); body.innerHTML = `<h5 class="mb-3">ไฟล์เสียงเดียวที่มี</h5><p>อัดเมื่อ: ${rec.timestamp.toLocaleString('th-TH')}</p><audio controls src="${audioUrl}" class="w-100"></audio>`; } 
                        else {
                            const earliestRec = recordings[0];
                            const latestRec = recordings[recordings.length - 1];
                            const earliestUrl = URL.createObjectURL(earliestRec.audioBlob);
                            const latestUrl = URL.createObjectURL(latestRec.audioBlob);
                            body.innerHTML = `<div class="row"><div class="col-md-6 mb-3 mb-md-0"><div class="card h-100"><div class="card-header"><h5><i class="bi bi-skip-start-circle"></i> การอัดครั้งแรก</h5></div><div class="card-body"><p><small>อัดเมื่อ: ${earliestRec.timestamp.toLocaleString('th-TH')}</small></p><audio controls class="w-100" src="${earliestUrl}"></audio></div></div></div><div class="col-md-6"><div class="card h-100"><div class="card-header"><h5><i class="bi bi-check-circle"></i> การอัดล่าสุด</h5></div><div class="card-body"><p><small>อัดเมื่อ: ${latestRec.timestamp.toLocaleString('th-TH')}</small></p><audio controls class="w-100" src="${latestUrl}"></audio></div></div></div></div>`;
                        }
                    } catch (err) { body.innerHTML = '<p class="text-center text-danger">ไม่สามารถโหลดข้อมูลเสียงได้</p>'; }
                }
            };
            
            const App = {
                startSession: (options) => { 
                    QuizSession = { ...options, dueQuestions: [], answeredThisSession: [], isAwaitingLevel: false, lastRecordingBlob: null }; 
                    let filtered = []; 
                    let categoryDisplay = options.category; 
                    if (options.category === 'all') { filtered = allUserQuestions; categoryDisplay = "ทั้งหมด"; } 
                    else if (options.category === 'due') { const now = new Date(); now.setHours(0, 0, 0, 0); filtered = allUserQuestions.filter(q => q.next_review_date.toDate() <= now); categoryDisplay = "ถึงกำหนดทวน"; } 
                    else { filtered = allUserQuestions.filter(q => q.category === options.category); } 
                    QuizSession.dueQuestions = filtered.sort(() => Math.random() - 0.5); 
                    QuizSession.categoryDisplay = categoryDisplay; 
                    if (QuizSession.dueQuestions.length === 0) { showAlert('ไม่มีคำศัพท์ที่ตรงตามเงื่อนไขนี้', 'info'); return; } 
                    UI.renderTestPage(); 
                },
                nextCard: () => { 
                    QuizSession.isAwaitingLevel = false;
                    QuizSession.lastRecordingBlob = null; 
                    const badge = document.getElementById('due-count-badge');
                    if(badge) badge.textContent = `เหลือ: ${QuizSession.dueQuestions.length}`;
                    const nextQ = QuizSession.dueQuestions.pop(); 
                    if (nextQ) { 
                        QuizSession.currentQuestion = nextQ;
                        if (QuizSession.mode === 'listen') {
                            UI.displayListenCard(nextQ);
                        } else {
                            UI.displaySpeakingQuizCard(nextQ);
                        }
                    } else { 
                        showAlert('รอบนี้เสร็จแล้ว!', 'success'); 
                        UI.renderMainMenu(); 
                    } 
                },
                
                skipCard: () => {
                    const q = QuizSession.currentQuestion;
                    if(q) {
                        QuizSession.dueQuestions.unshift(q); // Put it at the beginning of the array
                    }
                    App.nextCard();
                },

                handleQuizAnswer: async (action, btn) => {
                    if (action === 'start') {
                        if (RecordingService.isRecording || SpeechService.isListening) return;
                        RecordingService.startRecording(btn);
                        SpeechService.toggleListen(btn, 'en-US');
                    } else if (action === 'stop') {
                        if (!RecordingService.isRecording && !SpeechService.isListening) return;
                        const audioBlob = await RecordingService.stopRecording(btn);
                        QuizSession.lastRecordingBlob = audioBlob;
                        if(SpeechService.isListening) SpeechService.recognition.stop();
                    }
                },

                handleSpeechInput: (transcript) => {
                    // --- NEW: Sanitize function ---
                    const cleanString = (str) => {
                        if (!str) return "";
                        return str.toLowerCase().replace(/[.,/#!$%^&*;:{}=\-_`~()]/g,"").replace(/s$/, "").trim();
                    };

                    if (QuizSession.isAwaitingLevel) {
                        const thaiNumMap = { 'หนึ่ง': 1, 'สอง': 2, 'สาม': 3, 'สี่': 4, 'ห้า': 5 };
                        const match = transcript.match(/(?:level|เลเวล|เลเวว)?\s*([1-5])/i);
                        let level = null;
                        if (match && match[1]) { level = parseInt(match[1], 10); } 
                        else {
                            for (const word in thaiNumMap) {
                                if (transcript.includes(word)) { level = thaiNumMap[word]; break; }
                            }
                        }
                        if (level) { App.setReviewByLevel(level); } 
                        else { showAlert('ไม่เข้าใจระดับที่เลือก กรุณาลองอีกครั้ง', 'warning'); }
                        return;
                    }

                    if (QuizSession.mode === 'listen') {
                        const matchLevel = transcript.match(/(?:level|เลเวล|เลเวว)?\s*([1-5])/i);
                        if(matchLevel && matchLevel[1]) {
                           App.setReviewByLevel(parseInt(matchLevel[1]));
                        } else if (transcript.includes("อีกรอบ")) {
                            const q = QuizSession.currentQuestion;
                            if (q) SpeechService.speakPair(q.question, 'en-US', q.answer, 'th-TH');
                        } else {
                             showAlert('ไม่รู้จักคำสั่ง', 'warning');
                        }
                    } else if (QuizSession.mode === 'quiz') {
                        const q = QuizSession.currentQuestion;
                        const correctAnswer = q.question;
                        const isCorrect = cleanString(transcript) === cleanString(correctAnswer);
                        
                        UI.showQuizResult(isCorrect, transcript);
                    }
                },
                
                setReviewByLevel: async (level) => {
                    const q = QuizSession.currentQuestion;
                    if (!q) return;
                    document.querySelectorAll('#quiz-area button').forEach(b => b.disabled = true);
                    
                    if (QuizSession.lastRecordingBlob) {
                        try {
                            await IndexedDBService.addRecording(q.id, QuizSession.lastRecordingBlob);
                            showAlert('บันทึกเสียงลงในเบราว์เซอร์นี้แล้ว', 'success');
                        } catch (err) { showAlert('ไม่สามารถบันทึกเสียงได้', 'danger'); }
                    }

                    const daysToAdd = LEVEL_TO_DAYS_MAP[level] || 1; 
                    const nextReviewDate = new Date();
                    nextReviewDate.setHours(0, 0, 0, 0);
                    nextReviewDate.setDate(nextReviewDate.getDate() + daysToAdd);
                    await FirebaseService.updateQuestion(currentUser.uid, q.id, {
                        srs_level: level,
                        next_review_date: Timestamp.fromDate(nextReviewDate)
                    });
                    const qIndex = allUserQuestions.findIndex(item => item.id === q.id);
                    if (qIndex > -1) {
                        allUserQuestions[qIndex].srs_level = level;
                        allUserQuestions[qIndex].next_review_date = Timestamp.fromDate(nextReviewDate);
                    }
                    setTimeout(() => App.nextCard(), 500);
                }
            };
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
