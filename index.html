<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เว็บทบทวนคำศัพท์</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f0f2f5; }
        .container { max-width: 700px; }
        .card { border: none; border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        #alert-container { position: fixed; top: 1rem; right: 1rem; z-index: 1055; min-width: 250px; }
        .hidden { display: none !important; }
        .mic-listening { color: #dc3545; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); } }
    </style>
</head>
<body>
    <div class="container my-4">
        <div id="login-section">
            <div class="card p-4">
                <h2 class="text-center mb-4">เข้าสู่ระบบ</h2>
                <div class="mb-3"><label for="login-email" class="form-label">อีเมล</label><input type="email" id="login-email" class="form-control" required></div>
                <div class="mb-3"><label for="login-password" class="form-label">รหัสผ่าน</label><input type="password" id="login-password" class="form-control" required></div>
                <div class="d-grid gap-2"><button type="button" id="login-btn" class="btn btn-primary">เข้าสู่ระบบ</button></div>
                <p class="text-center mt-3 mb-0">ยังไม่มีบัญชี? <a href="#" id="go-to-register">สมัครสมาชิกที่นี่</a></p>
            </div>
        </div>
        <div id="register-section" class="hidden">
            <div class="card p-4">
                <h2 class="text-center mb-4">สมัครสมาชิกใหม่</h2>
                <div class="mb-3"><label for="register-email" class="form-label">อีเมล</label><input type="email" id="register-email" class="form-control" required></div>
                <div class="mb-3"><label for="register-password" class="form-label">รหัสผ่าน (6 ตัวอักษรขึ้นไป)</label><input type="password" id="register-password" class="form-control" required></div>
                <div class="d-grid gap-2"><button type="button" id="register-btn" class="btn btn-success">ยืนยันการสมัคร</button></div>
                <p class="text-center mt-3 mb-0">มีบัญชีอยู่แล้ว? <a href="#" id="go-to-login">กลับไปหน้าเข้าสู่ระบบ</a></p>
            </div>
        </div>
        
        <main id="app-root" class="hidden"></main>
    </div>

    <div id="alert-container"></div>
    
    <div class="modal fade" id="historyModal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="history-modal-title">ประวัติ</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="history-modal-body"></div></div></div></div>
    
    <div class="modal fade" id="startSessionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">เริ่มรอบทบทวน</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="category-select" class="form-label">เลือกชุดข้อมูล</label>
                        <select id="category-select" class="form-select">
                            <option value="all">ทบทวนทั้งหมด</option>
                            <option value="due">เฉพาะที่ถึงรอบทวน</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button><button type="button" id="confirm-start-btn" class="btn btn-primary">เริ่มต้น</button></div>
            </div>
        </div>
    </div>

    <template id="template-main-menu"><div class="card"><div class="card-body"><div class="d-flex justify-content-between align-items-center mb-4"><h5 class="mb-0" id="welcome-message"></h5><button id="logout-btn" class="btn btn-sm btn-outline-danger">ออกจากระบบ</button></div><div class="text-center p-2"><h1 class="text-primary mb-3">เว็บทบทวนคำศัพท์</h1><p class="text-muted mb-4">เลือกเมนูเพื่อเริ่มต้น</p><div class="d-grid gap-3"><button id="start-new-btn" class="btn btn-primary btn-lg"><i class="bi bi-stars"></i> เริ่มรอบทบทวน</button><button id="manage-btn" class="btn btn-outline-secondary"><i class="bi bi-gear-fill"></i> จัดการข้อมูล</button><button id="dashboard-btn" class="btn btn-outline-info"><i class="bi bi-graph-up"></i> ดูสถิติ</button></div></div></div></div></template>
    <template id="template-test"><div class="card"><div class="card-header bg-primary text-white d-flex justify-content-between align-items-center"><h3 class="fs-5 mb-0"><i class="bi bi-robot"></i> Voice-Guided Mode</h3><span id="due-count-badge" class="badge bg-light text-dark"></span></div><div class="card-body text-center" id="quiz-area"></div></div></template>
    <template id="template-manage"><button id="back-to-menu-btn" class="btn btn-secondary mb-3 w-100"><i class="bi bi-arrow-left"></i> กลับไปเมนูหลัก</button><div class="card mb-4"><div class="card-header bg-info text-white"><h5><i class="bi bi-plus-circle-fill"></i> เพิ่มข้อมูลใหม่ (คำศัพท์หรือประโยค)</h5></div><div class="card-body"><form id="add-form"><div class="mb-3"><label for="new-question" class="form-label">ประโยค (อังกฤษ, เว้นด้วย ___)</label><input type="text" id="new-question" class="form-control" placeholder="เช่น The ___ stores electrical energy." required></div><div class="mb-3"><label for="new-answer-word" class="form-label">คำตอบ (ที่เติมในช่องว่าง)</label><input type="text" id="new-answer-word" class="form-control" placeholder="เช่น capacitor" required></div><div class="mb-3"><label for="new-hint" class="form-label">ประโยคคำใบ้ (ไทย)</label><input type="text" id="new-hint" class="form-control" placeholder="เช่น ตัวเก็บประจุใช้เก็บพลังงานไฟฟ้า" required></div><div class="mb-3"><label for="new-category" class="form-label">หมวดหมู่</label><input type="text" id="new-category" class="form-control" required></div><button type="submit" class="btn btn-success w-100">เพิ่มข้อมูล</button></form></div></div><div class="card"><div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center"><h5><i class="bi bi-card-list"></i> คลังข้อมูลทั้งหมด</h5><button id="reset-data-btn" class="btn btn-danger btn-sm"><i class="bi bi-trash3-fill"></i> รีเซ็ตข้อมูลทั้งหมด</button></div><div class="card-body"><div id="questions-list" class="table-responsive"></div></div></div></template>
    <template id="template-dashboard"><button id="back-to-menu-btn" class="btn btn-secondary mb-3 w-100"><i class="bi bi-arrow-left"></i> กลับไปเมนูหลัก</button><div class="card mb-4"><div class="card-header bg-primary text-white"><h5><i class="bi bi-speedometer2"></i> แดชบอร์ดสรุปผล</h5></div><div class="card-body"><div class="row text-center mb-4"><div class="col"><h4 class="mb-0 text-primary" id="total-questions">0</h4><small class="text-muted">ข้อมูลทั้งหมด</small></div><div class="col"><h4 class="mb-0 text-warning" id="due-for-review">0</h4><small class="text-muted">ถึงรอบทวน</small></div></div><hr><h6 class="mb-3">สัดส่วนข้อมูลตามหมวดหมู่</h6><div style="position: relative; height:300px; width:100%"><canvas id="categoryChart"></canvas></div></div></div></template>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, getDocs, addDoc, deleteDoc, updateDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyDMmUxdlbAsjXdVr8JXfFV6zqVL2am9bwM",
            authDomain: "spaced-repetition-system-7ce8a.firebaseapp.com",
            projectId: "spaced-repetition-system-7ce8a",
            storageBucket: "spaced-repetition-system-7ce8a.firebasestorage.app",
            messagingSenderId: "668763983651",
            appId: "1:668763983651:web:3cc3df1c61d0165c764696",
            measurementId: "G-MPVL49Y2T4"
            };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const FirebaseService = { getQuestions: async (userId) => { const qCollection = collection(db, 'users', userId, 'words'); const snapshot = await getDocs(qCollection); return snapshot.docs.map(d => ({ id: d.id, ...d.data() })); }, addQuestion: (userId, data) => addDoc(collection(db, 'users', userId, 'words'), data), deleteQuestion: (userId, wordId) => deleteDoc(doc(db, 'users', userId, 'words', wordId)), updateQuestion: (userId, wordId, data) => updateDoc(doc(db, 'users', userId, 'words', wordId), data) };
        const SpeechService = {
            recognition: null, isListening: false,
            init: () => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) return;
                SpeechService.recognition = new SpeechRecognition();
                SpeechService.recognition.continuous = false;
                SpeechService.recognition.interimResults = false;
                SpeechService.recognition.onresult = (event) => App.handleSpeechInput(event.results[0][0].transcript.trim());
                 SpeechService.recognition.onerror = (event) => {
                    if (event.error !== 'no-speech') {
                       App.showAlert(`เกิดข้อผิดพลาด: ${event.error}`, 'danger');
                    }
                    App.handleSpeechEnd();
                };
                SpeechService.recognition.onend = () => App.handleSpeechEnd();
            },
            speak: (text, lang, onEndCallback = null) => {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = lang;
                    utterance.rate = (lang === 'th-TH') ? 0.9 : 1.0;
                    if (onEndCallback) utterance.onend = onEndCallback;
                    window.speechSynthesis.speak(utterance);
                } else if (onEndCallback) { onEndCallback(); }
            },
            cancelSpeech: () => {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                }
            },
            listen: (lang) => {
                if (!SpeechService.recognition || SpeechService.isListening) return;
                SpeechService.recognition.lang = lang;
                SpeechService.isListening = true;
                SpeechService.recognition.start();
            },
        };
        const RecordingService = {
            mediaRecorder: null, audioChunks: [], isRecording: false, stream: null,
            startRecording: async () => {
                if (RecordingService.isRecording) return;
                if (!navigator.mediaDevices?.getUserMedia) return App.showAlert('เบราว์เซอร์ไม่รองรับการอัดเสียง', 'danger');
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    RecordingService.stream = stream;
                    RecordingService.mediaRecorder = new MediaRecorder(stream);
                    RecordingService.audioChunks = [];
                    RecordingService.mediaRecorder.ondataavailable = event => RecordingService.audioChunks.push(event.data);
                    RecordingService.mediaRecorder.start();
                    RecordingService.isRecording = true;
                } catch (err) { App.showAlert('ไม่สามารถเข้าถึงไมโครโฟนได้', 'danger'); }
            },
            stopRecording: () => {
                return new Promise(resolve => {
                    if (!RecordingService.mediaRecorder || RecordingService.mediaRecorder.state === "inactive") return resolve(null);
                    RecordingService.mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(RecordingService.audioChunks, { type: 'audio/webm' });
                        RecordingService.stream?.getTracks().forEach(track => track.stop());
                        RecordingService.stream = null;
                        RecordingService.isRecording = false;
                        resolve(audioBlob);
                    };
                    RecordingService.mediaRecorder.stop();
                });
            }
        };
        const IndexedDBService = {
            db: null,
            init: () => {
                return new Promise((resolve, reject) => {
                    if (IndexedDBService.db) return resolve();
                    const request = indexedDB.open('audioHistoryDB', 1);
                    request.onerror = () => reject("Database error");
                    request.onsuccess = event => { IndexedDBService.db = event.target.result; resolve(); };
                    request.onupgradeneeded = event => event.target.result.createObjectStore('recordings', { keyPath: 'id', autoIncrement: true });
                });
            },
            addRecording: (wordId, audioBlob) => {
                return new Promise((resolve, reject) => {
                    const transaction = IndexedDBService.db.transaction(['recordings'], 'readwrite');
                    const store = transaction.objectStore('recordings');
                    const request = store.add({ wordId, audioBlob, timestamp: new Date() });
                    request.onsuccess = () => resolve();
                    request.onerror = event => reject(event.target.error);
                });
            },
            getRecordingsForWord: (wordId) => {
                return new Promise((resolve) => {
                    const recordings = [];
                    const transaction = IndexedDBService.db.transaction(['recordings'], 'readonly');
                    transaction.objectStore('recordings').openCursor().onsuccess = event => {
                        const cursor = event.target.result;
                        if (cursor) {
                            if (cursor.value.wordId === wordId) recordings.push(cursor.value);
                            cursor.continue();
                        } else {
                            resolve(recordings.sort((a, b) => a.timestamp - b.timestamp));
                        }
                    };
                });
            }
        };

        const App = {
            currentUser: null,
            allUserQuestions: [],
            quizSession: {},
            LEVEL_TO_MINUTES_MAP: { 1: 3, 2: 10, 3: 15, 4: 20, 5: 40 }, // 1 นาที, 10 นาที, 1 ชั่วโมง, 4 ชั่วโมง, 24 ชั่วโมง
            
            init() {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        this.currentUser = user;
                        await IndexedDBService.init();
                        this.allUserQuestions = await FirebaseService.getQuestions(user.uid);
                        SpeechService.init();
                        this.render('main-menu');
                    } else {
                        this.render('login');
                    }
                });
                this.bindAuthEvents();
            },
            
            bindAuthEvents() {
                document.getElementById('go-to-register').addEventListener('click', (e) => { e.preventDefault(); this.render('register'); });
                document.getElementById('go-to-login').addEventListener('click', (e) => { e.preventDefault(); this.render('login'); });
                document.getElementById('login-btn').addEventListener('click', () => signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-password').value).catch(() => this.showAlert("อีเมลหรือรหัสผ่านไม่ถูกต้อง", "danger")));
                document.getElementById('register-btn').addEventListener('click', () => createUserWithEmailAndPassword(auth, document.getElementById('register-email').value, document.getElementById('register-password').value).then(() => { this.showAlert('สมัครสมาชิกสำเร็จ!', 'success'); this.render('login'); }).catch(err => this.showAlert(err.message, "danger")));
            },

            render(page) {
                const appRoot = document.getElementById('app-root');
                appRoot.innerHTML = '';
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('register-section').classList.add('hidden');
                appRoot.classList.add('hidden');

                if (page === 'login') {
                    document.getElementById('login-section').classList.remove('hidden');
                } else if (page === 'register') {
                    document.getElementById('register-section').classList.remove('hidden');
                } else {
                    appRoot.classList.remove('hidden');
                    const template = document.getElementById(`template-${page}`).content.cloneNode(true);
                    appRoot.appendChild(template);
                    this.bindPageEvents(page);
                }
            },
            
            bindPageEvents(page) {
                if (page === 'main-menu') {
                    document.getElementById('welcome-message').textContent = `ยินดีต้อนรับ, ${this.currentUser.email}`;
                    document.getElementById('logout-btn').addEventListener('click', () => {
                        SpeechService.cancelSpeech();
                        signOut(auth);
                    });
                    document.getElementById('start-new-btn').addEventListener('click', () => this.showStartSessionModal());
                    document.getElementById('manage-btn').addEventListener('click', () => this.render('manage'));
                    document.getElementById('dashboard-btn').addEventListener('click', () => this.render('dashboard'));
                } else if (page === 'manage') {
                    document.getElementById('back-to-menu-btn').addEventListener('click', () => this.render('main-menu'));
                    this.renderManageList();
                    document.getElementById('add-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        await FirebaseService.addQuestion(this.currentUser.uid, { 
                            question: e.target.elements['new-question'].value, 
                            answer: e.target.elements['new-answer-word'].value, 
                            hint: e.target.elements['new-hint'].value, 
                            category: e.target.elements['new-category'].value, 
                            srs_level: 0, 
                            next_review_date: Timestamp.now() 
                        });
                        this.showAlert('เพิ่มข้อมูลสำเร็จ!');
                        this.allUserQuestions = await FirebaseService.getQuestions(this.currentUser.uid);
                        this.renderManageList();
                        e.target.reset();
                    });
                    document.getElementById('reset-data-btn').addEventListener('click', async () => {
                        if (confirm('คุณแน่ใจหรือไม่ว่าต้องการลบข้อมูลทั้งหมด? การกระทำนี้ไม่สามารถย้อนกลับได้')) {
                            for (const q of this.allUserQuestions) {
                                await FirebaseService.deleteQuestion(this.currentUser.uid, q.id);
                            }
                            this.showAlert('รีเซ็ตข้อมูลทั้งหมดแล้ว', 'success');
                            this.allUserQuestions = [];
                            this.renderManageList();
                        }
                    });
                } else if (page === 'dashboard') {
                    document.getElementById('back-to-menu-btn').addEventListener('click', () => this.render('main-menu'));
                    this.renderDashboard();
                }
            },
            
            async renderDashboard() {
                document.getElementById('total-questions').textContent = this.allUserQuestions.length;
                const now = new Date();
                const dueCount = this.allUserQuestions.filter(q => q.next_review_date.toDate() <= now).length;
                document.getElementById('due-for-review').textContent = dueCount;
                const categoryCounts = this.allUserQuestions.reduce((acc, q) => {
                    acc[q.category] = (acc[q.category] || 0) + 1;
                    return acc;
                }, {});
                new Chart(document.getElementById('categoryChart').getContext('2d'), {
                    type: 'pie',
                    data: {
                        labels: Object.keys(categoryCounts),
                        datasets: [{ data: Object.values(categoryCounts), backgroundColor: Object.keys(categoryCounts).map((_, i) => `hsl(${i * 60}, 70%, 70%)`), hoverOffset: 4 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
                });
            },

            async renderManageList() {
                const listContainer = document.getElementById('questions-list');
                if (!listContainer) return;
                listContainer.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div></div>';
                if (this.allUserQuestions.length === 0) { listContainer.innerHTML = '<p class="text-center text-muted">ยังไม่มีข้อมูล</p>'; return; }
                const now = new Date();
                let tableHTML = `<table class="table table-striped table-hover"><thead><tr><th>ประโยค / คำใบ้</th><th>สถานะ</th><th class="text-end">จัดการ</th></tr></thead><tbody>`;
                this.allUserQuestions.sort((a,b)=>a.question.localeCompare(b.question)).forEach(q => {
                    const due = q.next_review_date.toDate() <= now;
                    tableHTML += `<tr><td>${q.question.replace('___', `<strong>${q.answer}</strong>`)}<br><small class="text-muted">${q.hint}</small><br><small class="text-info">${q.category}</small></td><td><span class="badge bg-info">Lv. ${q.srs_level}</span> ${due ? `<span class="badge bg-warning">ถึงรอบทวน</span>` : ''}</td><td class="text-end"><button class="btn btn-sm btn-info recording-history-btn" data-word-id="${q.id}" data-word-q="${q.answer}"><i class="bi bi-clock-history"></i></button> <button class="btn btn-sm btn-danger delete-btn" data-id="${q.id}">ลบ</button></td></tr>`;
                });
                listContainer.innerHTML = tableHTML + `</tbody></table>`;
                listContainer.querySelectorAll('.delete-btn').forEach(b => b.addEventListener('click', async (e) => { if (confirm('ยืนยันการลบ?')) { await FirebaseService.deleteQuestion(this.currentUser.uid, e.currentTarget.dataset.id); this.showAlert('ลบข้อมูลแล้ว', 'warning'); this.allUserQuestions = await FirebaseService.getQuestions(this.currentUser.uid); this.renderManageList(); } }));
                listContainer.querySelectorAll('.recording-history-btn').forEach(b => b.addEventListener('click', (e) => this.showRecordingHistory(e.currentTarget.dataset.wordId, e.currentTarget.dataset.wordQ)));
            },
            
            showStartSessionModal() {
                const categorySelect = document.getElementById('category-select');
                categorySelect.innerHTML = '<option value="all">ทบทวนทั้งหมด</option><option value="due">เฉพาะที่ถึงรอบทวน</option>';
                const categories = [...new Set(this.allUserQuestions.map(q => q.category))];
                categories.forEach(cat => categorySelect.add(new Option(`เฉพาะหมวดหมู่: ${cat}`, cat)));
                const modal = new bootstrap.Modal(document.getElementById('startSessionModal'));
                modal.show();
                document.getElementById('confirm-start-btn').onclick = () => {
                    modal.hide();
                    this.startSession({ category: categorySelect.value });
                };
            },

            startSession(options) {
                this.quizSession = { ...options, dueQuestions: [], lastRecordingBlob: null, currentState: null };
                const now = new Date();
                let filtered = options.category === 'all' ? this.allUserQuestions : options.category === 'due' ? this.allUserQuestions.filter(q => q.next_review_date.toDate() <= now) : this.allUserQuestions.filter(q => q.category === options.category);
                this.quizSession.dueQuestions = filtered.sort(() => Math.random() - 0.5); 
                if (this.quizSession.dueQuestions.length === 0) return this.showAlert('ไม่มีข้อมูลที่ตรงตามเงื่อนไขนี้', 'info'); 
                this.render('test');
                this.nextCard();
            },

            nextCard() {
                SpeechService.cancelSpeech();
                const badge = document.getElementById('due-count-badge');
                if (badge) badge.textContent = `เหลือ: ${this.quizSession.dueQuestions.length}`;
                
                const nextQ = this.quizSession.dueQuestions.pop();
                if (nextQ) {
                    this.quizSession.currentQuestion = nextQ;
                    this.quizSession.lastRecordingBlob = null;
                    this.runCardSequence(nextQ, 'ask');
                } else {
                    this.showAlert('รอบนี้เสร็จแล้ว!', 'success');
                    this.render('main-menu');
                }
            },

            runCardSequence(q, step, data = {}) {
                const quizArea = document.getElementById('quiz-area');
                if (!quizArea) return;

                if (step === 'ask') {
                    quizArea.innerHTML = `<div class="my-4 p-3">
                        <p class="fs-5 text-muted">เติมคำในช่องว่าง:</p>
                        <h2 class="display-6 my-3">${q.question}</h2>
                        <i class="bi bi-mic-fill fs-1"></i>
                        <p id="status-text" class="text-muted mt-2">กำลังพูดคำใบ้...</p>
                    </div>`;
                    SpeechService.speak(q.hint, 'th-TH', () => {
                        SpeechService.speak('กรุณาพูดคำตอบครับ', 'th-TH', () => {
                            document.getElementById('status-text').textContent = 'กำลังฟังคำตอบ...';
                            document.querySelector('#quiz-area .bi-mic-fill').classList.add('mic-listening');
                            this.quizSession.currentState = 'AWAITING_ANSWER';
                            RecordingService.startRecording();
                            SpeechService.listen('en-US');
                        });
                    });
                } else if (step === 'feedback') {
                    const fullSentence = q.question.replace('___', `<strong>${q.answer}</strong>`);
                    quizArea.innerHTML = `<div class="my-4 p-3">
                        <h2 class="${data.isCorrect ? "text-success" : "text-danger"}">${data.isCorrect ? "ถูกต้อง!" : "ยังไม่ถูกต้อง"}</h2>
                        <p class="text-muted">คุณตอบว่า: <strong class="text-dark">"${data.transcript || '...'}"</strong></p><hr>
                        <p class="mt-3">ประโยคที่สมบูรณ์คือ:</p><h4 class="mt-3">${fullSentence}</h4>
                        <i class="bi bi-mic-fill fs-1 mt-4"></i>
                        <p id="status-text" class="text-muted mt-2">กำลังพูดเฉลย...</p>
                    </div>`;
                    SpeechService.speak(q.question.replace('___', q.answer), 'en-US', () => {
                        SpeechService.speak('คุณจำได้ดีแค่ไหน? กรุณาบอกเลเวล 1 ถึง 5', 'th-TH', () => {
                            document.getElementById('status-text').textContent = 'กรุณาบอกเลเวล 1 ถึง 5...';
                            document.querySelector('#quiz-area .bi-mic-fill').classList.add('mic-listening');
                            this.quizSession.currentState = 'AWAITING_LEVEL';
                            SpeechService.listen('th-TH');
                        });
                    });
                }
            },

            async handleSpeechInput(transcript) {
                const q = this.quizSession.currentQuestion;
                if (!q) return;

                if (this.quizSession.currentState === 'AWAITING_ANSWER') {
                    this.quizSession.lastRecordingBlob = await RecordingService.stopRecording();
                    const cleanString = (str) => str ? str.toLowerCase().replace(/[.,/#!$%^&*;:{}=\-_`~()]/g,"").trim() : "";
                    const isCorrect = cleanString(transcript) === cleanString(q.answer);
                    if (!isCorrect) this.quizSession.lastRecordingBlob = null;
                    this.runCardSequence(q, 'feedback', { isCorrect, transcript });

                } else if (this.quizSession.currentState === 'AWAITING_LEVEL') {
                    const thaiNumMap = { 'หนึ่ง': 1, 'สอง': 2, 'สาม': 3, 'สี่': 4, 'ห้า': 5 };
                    let level = null;
                    const match = transcript.match(/(?:level|เลเวล|เลเวว)?\s*([1-5])/i);
                    if (match?.[1]) { level = parseInt(match[1], 10); }
                    else { for (const word in thaiNumMap) if (transcript.includes(word)) { level = thaiNumMap[word]; break; } }
                    
                    if (level) {
                        this.setReviewByLevel(level);
                    } else {
                        SpeechService.speak('ไม่เข้าใจระดับที่เลือก กรุณาบอกเลเวล 1 ถึง 5 อีกครั้งครับ', 'th-TH', () => {
                            this.quizSession.currentState = 'AWAITING_LEVEL';
                            SpeechService.listen('th-TH');
                        });
                    }
                }
            },

            handleSpeechEnd() {
                SpeechService.isListening = false;
                const micIcon = document.querySelector('#quiz-area .bi-mic-fill');
                if (micIcon) micIcon.classList.remove('mic-listening');
            },
            
            async showRecordingHistory(wordId, wordQ) {
                const body = document.getElementById('history-modal-body');
                document.getElementById('history-modal-title').textContent = `เปรียบเทียบเสียง: ${wordQ}`;
                body.innerHTML = '<div class="text-center"><div class="spinner-border"></div></div>';
                const modal = new bootstrap.Modal(document.getElementById('historyModal'));
                modal.show();
                const recordings = await IndexedDBService.getRecordingsForWord(wordId);
                if (recordings.length === 0) { body.innerHTML = '<p class="text-center text-muted">ยังไม่มีเสียงที่อัดไว้</p>'; } 
                else if (recordings.length === 1) { const url = URL.createObjectURL(recordings[0].audioBlob); body.innerHTML = `<h5 class="mb-3">ไฟล์เสียงเดียวที่มี</h5><p>อัดเมื่อ: ${recordings[0].timestamp.toLocaleString('th-TH')}</p><audio controls src="${url}" class="w-100"></audio>`; } 
                else {
                    const first = recordings[0], last = recordings[recordings.length - 1];
                    const firstUrl = URL.createObjectURL(first.audioBlob), lastUrl = URL.createObjectURL(last.audioBlob);
                    body.innerHTML = `<div class="row"><div class="col-md-6 mb-3 mb-md-0"><div class="card h-100"><div class="card-header"><h5><i class="bi bi-skip-start-circle"></i> การอัดครั้งแรก</h5></div><div class="card-body"><p><small>อัดเมื่อ: ${first.timestamp.toLocaleString('th-TH')}</small></p><audio controls class="w-100" src="${firstUrl}"></audio></div></div></div><div class="col-md-6"><div class="card h-100"><div class="card-header"><h5><i class="bi bi-check-circle"></i> การอัดล่าสุด</h5></div><div class="card-body"><p><small>อัดเมื่อ: ${last.timestamp.toLocaleString('th-TH')}</small></p><audio controls class="w-100" src="${lastUrl}"></audio></div></div></div></div>`;
                }
            },
            
            async setReviewByLevel(level) {
                this.quizSession.currentState = null;
                const q = this.quizSession.currentQuestion;
                if (!q) return;

                const quizArea = document.getElementById('quiz-area');
                quizArea.innerHTML = `<div class="my-4 p-3"><p class="fs-5 text-muted">บันทึก Level ${level} แล้ว...</p><div class="spinner-border my-3" role="status"></div></div>`;

                if (this.quizSession.lastRecordingBlob) {
                    try {
                        await IndexedDBService.addRecording(q.id, this.quizSession.lastRecordingBlob);
                    } catch (err) { this.showAlert('ไม่สามารถบันทึกเสียงได้', 'danger'); }
                }

                const nextReviewDate = new Date();
                const minutesToAdd = this.LEVEL_TO_MINUTES_MAP[level] || 1;
                nextReviewDate.setMinutes(nextReviewDate.getMinutes() + minutesToAdd);
                
                await FirebaseService.updateQuestion(this.currentUser.uid, q.id, { srs_level: level, next_review_date: Timestamp.fromDate(nextReviewDate) });
                const qIndex = this.allUserQuestions.findIndex(item => item.id === q.id);
                if (qIndex > -1) this.allUserQuestions[qIndex] = {...this.allUserQuestions[qIndex], srs_level: level, next_review_date: Timestamp.fromDate(nextReviewDate)};
                
                setTimeout(() => this.nextCard(), 1000);
            },
            
            showAlert(msg, type = 'success') {
                const c = document.getElementById('alert-container');
                const el = document.createElement('div');
                el.className = `alert alert-${type} alert-dismissible fade show`;
                el.innerHTML = `${msg}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
                c.appendChild(el);
                setTimeout(() => bootstrap.Alert.getOrCreateInstance(el).close(), 3000);
            }
        };

        App.init();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
