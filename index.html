<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏ß‡πá‡∏ö‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå (Fixed)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f0f2f5; }
        .container { max-width: 700px; }
        .card { border: none; border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        #alert-container { position: fixed; top: 1rem; right: 1rem; z-index: 1055; min-width: 250px; }
        .hidden { display: none !important; }
        .mic-listening { color: #dc3545; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); } }
    </style>
</head>
<body>
    <div class="container my-4">
        <main id="app-root"></main>
    </div>

    <div id="alert-container"></div>
    
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
        <div id="due-toast" class="toast hide" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto">üîî ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                <p id="due-toast-message">‡∏°‡∏µ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ñ‡∏∂‡∏á‡∏£‡∏≠‡∏ö‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß!</p>
                <button id="start-due-toast-btn" class="btn btn-primary btn-sm w-100">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡πÄ‡∏•‡∏¢</button>
            </div>
        </div>
    </div>

    <div class="modal fade" id="startSessionModal" tabindex="-1" aria-labelledby="startSessionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="startSessionModalLabel">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="category-select" class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</label>
                        <select id="category-select" class="form-select">
                            <option value="all">‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                            <option value="due">‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏ñ‡∏∂‡∏á‡∏£‡∏≠‡∏ö‡∏ó‡∏ß‡∏ô</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="button" id="confirm-start-btn" class="btn btn-primary">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editQuestionModal" tabindex="-1" aria-labelledby="editQuestionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editQuestionModalLabel">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-form">
                        <input type="hidden" id="edit-id">
                        <div class="mb-3">
                            <label for="edit-question" class="form-label">‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ (‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©, ‡πÄ‡∏ß‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ___)</label>
                            <input type="text" id="edit-question" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-answer-word" class="form-label">‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</label>
                            <input type="text" id="edit-answer-word" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-hint" class="form-label">‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ (‡πÑ‡∏ó‡∏¢)</label>
                            <input type="text" id="edit-hint" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-category" class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                            <input type="text" id="edit-category" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-level" class="form-label">Level ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label>
                            <input type="number" id="edit-level" class="form-control" min="0" max="6" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-next-review" class="form-label">‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (Date/Time)</label>
                            <input type="datetime-local" id="edit-next-review" class="form-control" required>
                        </div>
                        <button type="submit" class="btn btn-success w-100">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <template id="template-main-menu">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="mb-0" id="welcome-message">‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå</h5>
                </div>
                <div class="text-center p-2">
                    <h1 class="text-primary mb-3">‡πÄ‡∏ß‡πá‡∏ö‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå</h1>
                    <p class="text-muted mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</p>
                    <div class="d-grid gap-3">
                        <button id="start-new-btn" class="btn btn-primary btn-lg"><i class="bi bi-stars"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô</button>
                        <button id="manage-btn" class="btn btn-outline-secondary"><i class="bi bi-gear-fill"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• / ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
                        <button id="dashboard-btn" class="btn btn-outline-info"><i class="bi bi-graph-up"></i> ‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</button>
                        <button id="history-btn" class="btn btn-outline-success"><i class="bi bi-clock-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô</button>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="template-test">
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h3 class="fs-5 mb-0" id="mode-header"><i class="bi bi-robot"></i> Voice-Guided Mode</h3>
                <span id="due-count-badge" class="badge bg-light text-dark"></span>
            </div>
            <div class="card-header bg-light p-2">
                <div class="progress" role="progressbar" style="height: 10px;">
                    <div id="quiz-progress-bar" class="progress-bar bg-info" style="width: 0%"></div>
                </div>
                <small id="progress-text" class="text-muted mt-1 d-block text-end">0/0</small>
            </div>
            <div class="card-body text-center" id="quiz-area">
                </div>
            
            <div class="card-footer bg-light p-3">
                <div class="form-check form-switch mb-3 d-flex justify-content-end">
                    <input class="form-check-input" type="checkbox" role="switch" id="typing-mode-toggle">
                    <label class="form-check-label ms-2" for="typing-mode-toggle">Typing Mode</label>
                </div>
                
                <div id="typing-input-area" class="input-group hidden">
                    <input type="text" id="typing-answer-input" class="form-control form-control-lg" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà" aria-label="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö">
                    <button class="btn btn-success btn-lg" type="button" id="submit-typing-btn">‡∏™‡πà‡∏á</button>
                </div>
            </div>
            
            <div id="debug-info" class="card-footer bg-light text-muted small" style="font-family: monospace;">
                </div>
        </div>
    </template>

    <template id="template-manage">
        <button id="back-to-menu-btn" class="btn btn-secondary mb-3 w-100"><i class="bi bi-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
        
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h5><i class="bi bi-megaphone-fill"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡πà‡∏≤‡∏ô (AI Voice)</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="th-voice-select" class="form-label">‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ)</label>
                    <select id="th-voice-select" class="form-select"></select>
                </div>
                <div class="mb-3">
                    <label for="en-voice-select" class="form-label">‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ/‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö)</label>
                    <select id="en-voice-select" class="form-select"></select>
                </div>
                <button id="test-voice-btn" class="btn btn-outline-secondary w-100">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5><i class="bi bi-plus-circle-fill"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà</h5>
            </div>
            <div class="card-body">
                <form id="add-form">
                    <div class="mb-3">
                        <label for="new-question" class="form-label">‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ (‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©, ‡πÄ‡∏ß‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ___)</label>
                        <input type="text" id="new-question" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô I ___ water." required>
                    </div>
                    <div class="mb-3">
                        <label for="new-answer-word" class="form-label">‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</label>
                        <input type="text" id="new-answer-word" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô want" required>
                    </div>
                    <div class="mb-3">
                        <label for="new-hint" class="form-label">‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ (‡πÑ‡∏ó‡∏¢)</label>
                        <input type="text" id="new-hint" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏â‡∏±‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡πâ‡∏≥" required>
                    </div>
                    <div class="mb-3">
                        <label for="new-category" class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                        <input type="text" id="new-category" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1" required>
                    </div>
                    <button type="submit" class="btn btn-success w-100">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </form>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                <h5><i class="bi bi-card-list"></i> ‡∏Ñ‡∏•‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h5>
                <button id="reset-data-btn" class="btn btn-danger btn-sm"><i class="bi bi-trash3-fill"></i> ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>
            <div class="card-body">
                <div id="questions-list" class="table-responsive">
                    </div>
            </div>
            <div class="card-footer bg-light">
                <h6 class="mb-3"><i class="bi bi-hdd-stack"></i> ‡∏™‡∏≥‡∏£‡∏≠‡∏á/‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (JSON)</h6>
                <div class="d-flex gap-2">
                    <button id="export-data-btn" class="btn btn-outline-primary btn-sm"><i class="bi bi-download"></i> ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (JSON)</button>
                    <label for="import-file-input" class="btn btn-outline-warning btn-sm mb-0">
                        <i class="bi bi-upload"></i> ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (JSON)
                    </label>
                    <input type="file" id="import-file-input" accept=".json" class="hidden">
                </div>
            </div>
        </div>
    </template>

    <template id="template-dashboard">
        <button id="back-to-menu-btn" class="btn btn-secondary mb-3 w-100"><i class="bi bi-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5><i class="bi bi-speedometer2"></i> ‡πÅ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</h5>
            </div>
            <div class="card-body">
                <div class="row text-center mb-4">
                    <div class="col">
                        <h4 class="mb-0 text-primary" id="total-questions">0</h4>
                        <small class="text-muted">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small>
                    </div>
                    <div class="col">
                        <h4 class="mb-0 text-warning" id="due-for-review">0</h4>
                        <small class="text-muted">‡∏ñ‡∏∂‡∏á‡∏£‡∏≠‡∏ö‡∏ó‡∏ß‡∏ô</small>
                    </div>
                </div>
                <hr>
                <h6 class="mb-3">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á Level</h6>
                <div style="position: relative; height:300px; width:100%" class="mb-4">
                    <canvas id="levelChart"></canvas>
                </div>
                <hr>
                <h6 class="mb-3">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h6>
                <div style="position: relative; height:300px; width:100%">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>
    </template>

    <template id="template-history">
        <button id="back-to-menu-btn" class="btn btn-secondary mb-3 w-100"><i class="bi bi-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5><i class="bi bi-clock-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h5>
            </div>
            <div class="card-body">
                <div id="history-stats" class="row text-center mb-4">
                    <div class="col">
                        <h4 class="mb-0 text-dark" id="total-sessions">0</h4>
                        <small class="text-muted">‡∏Å‡∏≤‡∏£‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small>
                    </div>
                    <div class="col">
                        <h4 class="mb-0 text-success" id="total-correct">0</h4>
                        <small class="text-muted">‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</small>
                    </div>
                    <div class="col">
                        <h4 class="mb-0 text-danger" id="total-incorrect">0</h4>
                        <small class="text-muted">‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î/‡∏Ç‡πâ‡∏≤‡∏°</small>
                    </div>
                </div>
                <hr>
                <div id="history-list-container" class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                    </div>
            </div>
        </div>
    </template>

    <script>
        /**
         * ---------------------------------------------------------------------
         * ‡∏£‡∏∞‡∏ö‡∏ö Spaced Repetition System (SRS) & Web Speech API
         * ---------------------------------------------------------------------
         */

        const INITIAL_QUESTIONS = [
            { question: "___ do you want?", answer: "What", hint: "‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏£", category: "Lesson 1" },
            { question: "I ___ water.", answer: "want", hint: "‡∏â‡∏±‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡πâ‡∏≥", category: "Lesson 1" },
            { question: "I want ___.", answer: "water", hint: "‡∏â‡∏±‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡πâ‡∏≥", category: "Lesson 1" },
            { question: "I want ___ water.", answer: "cold", hint: "‡∏â‡∏±‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡πâ‡∏≥‡πÄ‡∏¢‡πá‡∏ô", category: "Lesson 1" },
            { question: "I want cold ___.", answer: "water", hint: "‡∏â‡∏±‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡πâ‡∏≥‡πÄ‡∏¢‡πá‡∏ô", category: "Lesson 1" }
        ];

        // ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Ñ‡∏•‡∏∂‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
        const Levenshtein = {
            distance: (s1, s2) => {
                s1 = s1.toLowerCase();
                s2 = s2.toLowerCase();
                const costs = [];
                for (let i = 0; i <= s1.length; i++) {
                    let lastValue = i;
                    for (let j = 0; j <= s2.length; j++) {
                        if (i === 0)
                            costs[j] = j;
                        else {
                            if (j > 0) {
                                let newValue = costs[j - 1];
                                if (s1.charAt(i - 1) !== s2.charAt(j - 1))
                                    newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                                costs[j - 1] = lastValue;
                                lastValue = newValue;
                            }
                        }
                    }
                    if (i > 0) costs[s2.length] = lastValue;
                }
                return costs[s2.length];
            },
            isCloseEnough: (s1, s2) => {
                const maxLen = Math.max(s1.length, s2.length);
                const maxError = Math.floor(maxLen * 0.25) + 1;
                return Levenshtein.distance(s1, s2) <= maxError;
            }
        };

        const LocalStorageService = {
            getQuestions: async () => {
                const data = localStorage.getItem('srsAppQuestions');
                if (!data) return [];
                return JSON.parse(data).map(q => ({
                    ...q,
                    next_review_date: new Date(q.next_review_date),
                    created_at: q.created_at ? new Date(q.created_at) : new Date()
                }));
            },
            saveQuestions: async (questions) => {
                const dataToSave = questions.map(q => ({
                    ...q,
                    next_review_date: q.next_review_date.toISOString(),
                    created_at: (q.created_at || new Date()).toISOString()
                }));
                localStorage.setItem('srsAppQuestions', JSON.stringify(dataToSave));
            },
            addQuestion: async (data) => {
                const questions = await LocalStorageService.getQuestions();
                const newQuestion = {
                    ...data,
                    id: `local_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`,
                    srs_level: data.srs_level || 0,
                    next_review_date: data.next_review_date || new Date(),
                    created_at: new Date()
                };
                questions.push(newQuestion);
                await LocalStorageService.saveQuestions(questions);
            },
            deleteQuestion: async (wordId) => {
                let questions = await LocalStorageService.getQuestions();
                questions = questions.filter(q => q.id !== wordId);
                await LocalStorageService.saveQuestions(questions);
            },
            updateQuestion: async (wordId, data) => {
                let questions = await LocalStorageService.getQuestions();
                const idx = questions.findIndex(q => q.id === wordId);
                if (idx > -1) {
                    questions[idx] = { ...questions[idx], ...data };
                    await LocalStorageService.saveQuestions(questions);
                }
            },
            getHistory: async () => {
                const data = localStorage.getItem('srsAppHistory');
                return data ? JSON.parse(data) : [];
            },
            logSessionResult: async (questionId, isCorrect, srsLevel, transcript, mode) => {
                const history = await LocalStorageService.getHistory();
                const log = {
                    timestamp: new Date().toISOString(),
                    question_id: questionId,
                    is_correct: isCorrect,
                    srs_level: srsLevel,
                    transcript: transcript,
                    mode: mode
                };
                history.unshift(log);
                localStorage.setItem('srsAppHistory', JSON.stringify(history.slice(0, 1000))); // ‡πÄ‡∏Å‡πá‡∏ö 1000 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
            }
        };

        const SpeechService = {
            recognition: null,
            isListening: false,
            init: () => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    console.error("Speech Recognition not supported");
                    return;
                }
                SpeechService.recognition = new SpeechRecognition();
                SpeechService.recognition.continuous = false;
                SpeechService.recognition.interimResults = false;

                SpeechService.recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript.trim();
                    App.handleSpeechInput(transcript);
                };

                SpeechService.recognition.onerror = (event) => {
                    if (event.error === 'no-speech' && SpeechService.isListening) {
                        SpeechService.recognition.stop();
                        setTimeout(() => SpeechService.listen(SpeechService.recognition.lang), 100);
                    }
                };

                SpeechService.recognition.onend = () => {
                    SpeechService.isListening = false;
                    App.handleSpeechEnd();
                };
            },
            speak: (text, lang, onEndCallback = null) => {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = lang;
                
                // ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô
                if (lang.startsWith('th')) utterance.rate = 0.9;
                else utterance.rate = 1.0;

                // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ
                const savedVoiceURI = localStorage.getItem(lang.startsWith('th') ? 'thVoiceURI' : 'enVoiceURI');
                if (savedVoiceURI) {
                    const voices = window.speechSynthesis.getVoices();
                    const selectedVoice = voices.find(v => v.voiceURI === savedVoiceURI);
                    if (selectedVoice) utterance.voice = selectedVoice;
                }

                if (onEndCallback) utterance.onend = onEndCallback;
                window.speechSynthesis.speak(utterance);
            },
            listen: (lang) => {
                if (!SpeechService.recognition || App.isTypingMode) return;
                SpeechService.recognition.lang = lang;
                try {
                    SpeechService.recognition.start();
                    SpeechService.isListening = true;
                } catch (e) {
                    console.log("Recognition already started");
                }
            }
        };

        const App = {
            allUserQuestions: [],
            quizSession: {
                queue: [],
                currentIndex: 0,
                currentQuestion: null,
                lastTranscript: "",
                step: 'intro' 
            },
            isTypingMode: false,
            
            // ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ SRS (‡∏ô‡∏≤‡∏ó‡∏µ/‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á/‡∏ß‡∏±‡∏ô)
            LEVEL_TO_INTERVAL_MAP: {
                0: { unit: 'minutes', value: 0 },   // New
                1: { unit: 'minutes', value: 2 },   // Level 1: ‡∏ó‡∏ß‡∏ô‡∏ã‡πâ‡∏≥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                2: { unit: 'hours', value: 1 },     // Level 2: 1 ‡∏ä‡∏°.
                3: { unit: 'days', value: 1 },      // Level 3: 1 ‡∏ß‡∏±‡∏ô
                4: { unit: 'days', value: 4 },      // Level 4: 4 ‡∏ß‡∏±‡∏ô
                5: { unit: 'days', value: 10 },     // Level 5: 10 ‡∏ß‡∏±‡∏ô
                6: { unit: 'days', value: 30 }      // Level 6: 30 ‡∏ß‡∏±‡∏ô (Mastered)
            },

            async init() {
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                if (!localStorage.getItem('srsAppQuestions')) {
                    const initialData = INITIAL_QUESTIONS.map(q => ({
                        ...q,
                        id: `local_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`,
                        srs_level: 0,
                        next_review_date: new Date(),
                        created_at: new Date()
                    }));
                    await LocalStorageService.saveQuestions(initialData);
                }

                this.allUserQuestions = await LocalStorageService.getQuestions();
                SpeechService.init();
                this.render('main-menu');

                // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ñ‡∏∂‡∏á‡∏£‡∏≠‡∏ö‡∏ó‡∏ß‡∏ô
                this.startDueItemsCheck();
            },

            render(page) {
                // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                this.isTypingMode = false;
                window.speechSynthesis.cancel();
                if (SpeechService.recognition) {
                    try { SpeechService.recognition.stop(); } catch(e){}
                }

                const root = document.getElementById('app-root');
                root.innerHTML = '';
                const template = document.getElementById(`template-${page}`);
                if (template) {
                    const content = template.content.cloneNode(true);
                    root.appendChild(content);
                    this.bindPageEvents(page);
                }
            },

            bindPageEvents(page) {
                if (page === 'main-menu') {
                    document.getElementById('start-new-btn').onclick = () => {
                        const modal = new bootstrap.Modal(document.getElementById('startSessionModal'));
                        modal.show();
                    };
                    document.getElementById('confirm-start-btn').onclick = () => {
                        const type = document.getElementById('category-select').value;
                        bootstrap.Modal.getInstance(document.getElementById('startSessionModal')).hide();
                        this.startQuizSession(type);
                    };
                    document.getElementById('manage-btn').onclick = () => this.render('manage');
                    document.getElementById('dashboard-btn').onclick = () => this.render('dashboard');
                    document.getElementById('history-btn').onclick = () => this.render('history');

                } else if (page === 'manage') {
                    document.getElementById('back-to-menu-btn').onclick = () => this.render('main-menu');
                    this.renderManageList();
                    this.setupManageVoiceControls();
                    
                    document.getElementById('add-form').onsubmit = async (e) => {
                        e.preventDefault();
                        const q = document.getElementById('new-question').value;
                        const a = document.getElementById('new-answer-word').value;
                        const h = document.getElementById('new-hint').value;
                        const c = document.getElementById('new-category').value;
                        await LocalStorageService.addQuestion({ question: q, answer: a, hint: h, category: c });
                        this.allUserQuestions = await LocalStorageService.getQuestions();
                        this.renderManageList();
                        e.target.reset();
                        this.showAlert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                    };

                    document.getElementById('reset-data-btn').onclick = async () => {
                        if (confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) {
                            localStorage.clear();
                            location.reload();
                        }
                    };

                    document.getElementById('export-data-btn').onclick = () => {
                        const dataStr = JSON.stringify(this.allUserQuestions);
                        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                        const exportFileDefaultName = 'vocabulary_backup.json';
                        const linkElement = document.createElement('a');
                        linkElement.setAttribute('href', dataUri);
                        linkElement.setAttribute('download', exportFileDefaultName);
                        linkElement.click();
                    };

                    document.getElementById('import-file-input').onchange = (e) => {
                        const file = e.target.files[0];
                        if (!file) return;
                        const reader = new FileReader();
                        reader.onload = async (evt) => {
                            try {
                                const imported = JSON.parse(evt.target.result);
                                if (confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${imported.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                                    await LocalStorageService.saveQuestions(imported);
                                    this.allUserQuestions = await LocalStorageService.getQuestions();
                                    this.renderManageList();
                                    this.showAlert('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                                }
                            } catch (err) {
                                alert('‡πÑ‡∏ü‡∏•‡πå JSON ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                            }
                        };
                        reader.readAsText(file);
                    };

                    document.getElementById('edit-form').onsubmit = async (e) => {
                        e.preventDefault();
                        const id = document.getElementById('edit-id').value;
                        const data = {
                            question: document.getElementById('edit-question').value,
                            answer: document.getElementById('edit-answer-word').value,
                            hint: document.getElementById('edit-hint').value,
                            category: document.getElementById('edit-category').value,
                            srs_level: parseInt(document.getElementById('edit-level').value),
                            next_review_date: new Date(document.getElementById('edit-next-review').value)
                        };
                        await LocalStorageService.updateQuestion(id, data);
                        this.allUserQuestions = await LocalStorageService.getQuestions();
                        bootstrap.Modal.getInstance(document.getElementById('editQuestionModal')).hide();
                        this.renderManageList();
                        this.showAlert('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    };

                } else if (page === 'test') {
                    document.getElementById('typing-mode-toggle').onchange = (e) => {
                        this.toggleTypingMode(e.target.checked);
                    };
                    document.getElementById('submit-typing-btn').onclick = () => {
                        const input = document.getElementById('typing-answer-input');
                        this.handleTypingInput(input.value);
                        input.value = '';
                    };
                } else if (page === 'dashboard') {
                    document.getElementById('back-to-menu-btn').onclick = () => this.render('main-menu');
                    this.renderDashboard();
                } else if (page === 'history') {
                    document.getElementById('back-to-menu-btn').onclick = () => this.render('main-menu');
                    this.renderHistory();
                }
            },

            // ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô (Quiz Logic)
            async startQuizSession(mode) {
                let queue = [];
                const now = new Date();
                
                if (mode === 'all') {
                    queue = [...this.allUserQuestions];
                } else if (mode === 'due') {
                    queue = this.allUserQuestions.filter(q => q.next_review_date <= now);
                }

                if (queue.length === 0) {
                    this.showAlert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ!', 'info');
                    return;
                }

                // ‡∏™‡∏∏‡πà‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö
                queue.sort(() => Math.random() - 0.5);

                this.quizSession = {
                    queue: queue,
                    currentIndex: 0,
                    currentQuestion: queue[0],
                    lastTranscript: "",
                    step: 'intro'
                };

                this.render('test');
                this.updateProgressBar();
                this.updateDueBadge();
                this.runCardSequence(this.quizSession.currentQuestion, 'intro');
            },

            updateProgressBar() {
                const total = this.quizSession.queue.length;
                const current = this.quizSession.currentIndex + 1;
                const percent = (current / total) * 100;
                const bar = document.getElementById('quiz-progress-bar');
                const text = document.getElementById('progress-text');
                if (bar) bar.style.width = `${percent}%`;
                if (text) text.textContent = `${current}/${total}`;
            },

            updateDueBadge() {
                const badge = document.getElementById('due-count-badge');
                if (badge) {
                    const remaining = this.quizSession.queue.length - this.quizSession.currentIndex;
                    badge.textContent = `${remaining} card${remaining > 1 ? 's' : ''} left`;
                }
                this.updateDebugQueue();
            },

            toggleTypingMode(enabled) {
                this.isTypingMode = enabled;
                const inputArea = document.getElementById('typing-input-area');
                const header = document.getElementById('mode-header');
                
                if (enabled) {
                    inputArea.classList.remove('hidden');
                    header.innerHTML = `<i class="bi bi-keyboard"></i> Typing Mode`;
                    if (SpeechService.recognition) SpeechService.recognition.stop();
                    document.getElementById('typing-answer-input').focus();
                } else {
                    inputArea.classList.add('hidden');
                    header.innerHTML = `<i class="bi bi-robot"></i> Voice-Guided Mode`;
                    // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á (answer-listening) ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà
                    if (this.quizSession.step === 'answer-listening') {
                        SpeechService.listen('en-US');
                    }
                }
            },

            runCardSequence(question, step, data = {}) {
                this.quizSession.step = step;
                const container = document.getElementById('quiz-area');
                if (!container) return;

                if (step === 'intro') {
                    container.innerHTML = `
                        <div class="mb-4">
                            <h2 class="display-6 mb-3">‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•: <span class="text-primary">${question.hint}</span></h2>
                            <p class="text-muted fs-4">${question.question.replace('___', ' ( ... ) ')}</p>
                        </div>
                        <div class="mt-5">
                            <span class="badge bg-secondary p-2">Level: ${question.srs_level}</span>
                            <span class="badge bg-light text-dark p-2">Category: ${question.category}</span>
                        </div>
                    `;
                    
                    SpeechService.speak(`‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤: ${question.hint}`, 'th-TH', () => {
                        setTimeout(() => this.runCardSequence(question, 'question-reading'), 500);
                    });

                } else if (step === 'question-reading') {
                    const displayQuestion = question.question.replace('___', `<span class="border-bottom border-primary text-primary px-3">_____</span>`);
                    container.innerHTML = `
                        <div class="mb-4">
                            <h2 class="display-6 mb-3 text-muted">${question.hint}</h2>
                            <p class="fs-1 fw-bold">${displayQuestion}</p>
                        </div>
                        <div class="mt-4">
                            <div class="spinner-grow text-primary" role="status"></div>
                            <p class="mt-2 text-primary">‡∏ü‡∏±‡∏á‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ...</p>
                        </div>
                    `;
                    
                    const speakText = question.question.replace('___', '... blank ...');
                    SpeechService.speak(speakText, 'en-US', () => {
                        setTimeout(() => this.runCardSequence(question, 'answer-listening'), 500);
                    });

                } else if (step === 'answer-listening') {
                    container.innerHTML = `
                        <div class="mb-4">
                            <h2 class="display-6 mb-3 text-muted">${question.hint}</h2>
                            <p class="fs-2">${question.question.replace('___', ' ( ? ) ')}</p>
                        </div>
                        <div id="status-ui" class="mt-4">
                            ${this.isTypingMode ? 
                                `<div class="p-3 bg-light rounded border border-success">
                                    <h4 class="text-success"><i class="bi bi-keyboard"></i> ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö...</h4>
                                    <p class="mb-0">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á</p>
                                </div>` :
                                `<div class="p-3 bg-light rounded border border-danger mic-listening">
                                    <h4 class="text-danger"><i class="bi bi-mic-fill"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö...</h4>
                                    <p class="mb-0">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏π‡∏î‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á</p>
                                </div>`
                            }
                        </div>
                    `;
                    
                    if (!this.isTypingMode) {
                        SpeechService.listen('en-US');
                    } else {
                        document.getElementById('typing-answer-input').focus();
                    }

                } else if (step === 'correct') {
                    const finalSentence = question.question.replace('___', question.answer);
                    container.innerHTML = `
                        <div class="mb-4">
                            <i class="bi bi-check-circle-fill text-success display-1"></i>
                            <h2 class="text-success mt-3 fw-bold">‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!</h2>
                            <p class="fs-3 mt-4">${finalSentence}</p>
                            <p class="text-muted mt-2">‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏∑‡∏≠: <strong>${question.answer}</strong></p>
                        </div>
                    `;
                    
                    SpeechService.speak(`Excellent! The answer is ${question.answer}.`, 'en-US', () => {
                        SpeechService.speak(finalSentence, 'en-US');
                    });

                    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Level ‡πÉ‡∏´‡∏°‡πà (‡∏Ç‡∏∂‡πâ‡∏ô 1 ‡∏£‡∏∞‡∏î‡∏±‡∏ö)
                    const nextLevel = Math.min(question.srs_level + 1, 6);
                    this.setReviewByLevel(nextLevel);

                } else if (step === 'incorrect') {
                    const finalSentence = question.question.replace('___', question.answer);
                    container.innerHTML = `
                        <div class="mb-4">
                            <i class="bi bi-x-circle-fill text-danger display-1"></i>
                            <h2 class="text-danger mt-3 fw-bold">‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</h2>
                            <p class="fs-4 mt-2">‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏û‡∏π‡∏î: <span class="text-muted">"${data.transcript || '...'}"</span></p>
                            <p class="fs-3 mt-4">‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏∑‡∏≠: <span class="text-primary fw-bold">${question.answer}</span></p>
                            <p class="text-muted fs-5 mt-2">${finalSentence}</p>
                        </div>
                    `;
                    
                    SpeechService.speak(`Not quite. The correct answer is ${question.answer}.`, 'en-US', () => {
                        SpeechService.speak(finalSentence, 'en-US');
                    });

                    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Level ‡πÉ‡∏´‡∏°‡πà (‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ Level 1 ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏î‡∏•‡∏á)
                    const nextLevel = 1; 
                    this.setReviewByLevel(nextLevel);
                }
            },

            handleSpeechInput(transcript) {
                if (this.quizSession.step !== 'answer-listening') return;
                
                this.quizSession.lastTranscript = transcript;
                const question = this.quizSession.currentQuestion;
                const isCorrect = Levenshtein.isCloseEnough(transcript, question.answer);
                
                if (isCorrect) {
                    this.runCardSequence(question, 'correct');
                } else {
                    this.runCardSequence(question, 'incorrect', { transcript: transcript });
                }
            },

            handleTypingInput(value) {
                if (this.quizSession.step !== 'answer-listening') return;
                
                this.quizSession.lastTranscript = value;
                const question = this.quizSession.currentQuestion;
                const isCorrect = Levenshtein.isCloseEnough(value.trim(), question.answer);
                
                if (isCorrect) {
                    this.runCardSequence(question, 'correct');
                } else {
                    this.runCardSequence(question, 'incorrect', { transcript: value });
                }
            },

            handleSpeechEnd() {
                // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ ‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏ï‡πà‡∏≠
                if (this.quizSession.step === 'answer-listening' && !this.isTypingMode) {
                    setTimeout(() => {
                        if (this.quizSession.step === 'answer-listening' && !SpeechService.isListening) {
                            SpeechService.listen('en-US');
                        }
                    }, 500);
                }
            },

            async setReviewByLevel(level) {
                const q = this.quizSession.currentQuestion;
                if (!q) return;

                const isCorrect = level > 1;
                await LocalStorageService.logSessionResult(
                    q.id, 
                    isCorrect, 
                    level, 
                    this.quizSession.lastTranscript, 
                    this.isTypingMode ? 'typing' : 'voice'
                );

                const nextDate = new Date();
                const interval = this.LEVEL_TO_INTERVAL_MAP[level];
                
                if (interval.unit === 'minutes') {
                    nextDate.setMinutes(nextDate.getMinutes() + interval.value);
                } else if (interval.unit === 'hours') {
                    nextDate.setHours(nextDate.getHours() + interval.value);
                } else {
                    nextDate.setDate(nextDate.getDate() + interval.value);
                }

                await LocalStorageService.updateQuestion(q.id, {
                    srs_level: level,
                    next_review_date: nextDate
                });

                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô UI Memory
                this.allUserQuestions = await LocalStorageService.getQuestions();

                // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                setTimeout(() => this.nextCard(), 4000);
            },

            nextCard() {
                this.quizSession.currentIndex++;
                if (this.quizSession.currentIndex < this.quizSession.queue.length) {
                    this.quizSession.currentQuestion = this.quizSession.queue[this.quizSession.currentIndex];
                    this.updateProgressBar();
                    this.updateDueBadge();
                    this.runCardSequence(this.quizSession.currentQuestion, 'intro');
                } else {
                    this.finishSession();
                }
            },

            finishSession() {
                const container = document.getElementById('quiz-area');
                container.innerHTML = `
                    <div class="py-5">
                        <i class="bi bi-trophy-fill text-warning display-1"></i>
                        <h2 class="mt-4 fw-bold">‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h2>
                        <p class="text-muted">‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏ö‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß</p>
                        <button onclick="App.render('main-menu')" class="btn btn-primary btn-lg mt-3">
                            <i class="bi bi-house"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å
                        </button>
                    </div>
                `;
                SpeechService.speak("Congratulations! You have completed your review session.", "en-US");
            },

            // ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            renderManageList() {
                const listContainer = document.getElementById('questions-list');
                if (!listContainer) return;

                if (this.allUserQuestions.length === 0) {
                    listContainer.innerHTML = '<p class="text-center text-muted py-3">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á</p>';
                    return;
                }

                let html = `
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ (‡πÑ‡∏ó‡∏¢)</th>
                                <th>‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ / ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</th>
                                <th>Level</th>
                                <th class="text-end">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                this.allUserQuestions.forEach(q => {
                    const nextStr = q.next_review_date.toLocaleString('th-TH');
                    html += `
                        <tr>
                            <td>
                                <strong>${q.hint}</strong><br>
                                <small class="text-muted">${q.category}</small>
                            </td>
                            <td>
                                <span class="text-muted">${q.question.replace('___', '___')}</span><br>
                                <span class="text-success fw-bold">${q.answer}</span>
                            </td>
                            <td>
                                <span class="badge bg-primary">Lv.${q.srs_level}</span><br>
                                <small class="text-muted" style="font-size: 0.7rem;">‡∏ó‡∏ß‡∏ô: ${nextStr}</small>
                            </td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-warning" onclick="App.showEditModal('${q.id}')">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="App.deleteWord('${q.id}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                listContainer.innerHTML = html;
            },

            showEditModal(id) {
                const q = this.allUserQuestions.find(item => item.id === id);
                if (!q) return;

                document.getElementById('edit-id').value = q.id;
                document.getElementById('edit-question').value = q.question;
                document.getElementById('edit-answer-word').value = q.answer;
                document.getElementById('edit-hint').value = q.hint;
                document.getElementById('edit-category').value = q.category;
                document.getElementById('edit-level').value = q.srs_level;
                
                // ‡πÅ‡∏õ‡∏•‡∏á Date ‡πÄ‡∏õ‡πá‡∏ô format ‡∏Ç‡∏≠‡∏á datetime-local (YYYY-MM-DDThh:mm)
                const date = q.next_review_date;
                const tzOffset = date.getTimezoneOffset() * 60000;
                const localISODate = (new Date(date - tzOffset)).toISOString().slice(0, 16);
                document.getElementById('edit-next-review').value = localISODate;

                const modal = new bootstrap.Modal(document.getElementById('editQuestionModal'));
                modal.show();
            },

            async deleteWord(id) {
                if (confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ô‡∏µ‡πâ?')) {
                    await LocalStorageService.deleteQuestion(id);
                    this.allUserQuestions = await LocalStorageService.getQuestions();
                    this.renderManageList();
                    this.showAlert('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'danger');
                }
            },

            setupManageVoiceControls() {
                const thSelect = document.getElementById('th-voice-select');
                const enSelect = document.getElementById('en-voice-select');
                const testBtn = document.getElementById('test-voice-btn');

                const populateVoices = () => {
                    const voices = window.speechSynthesis.getVoices();
                    if (voices.length === 0) return;

                    thSelect.innerHTML = '';
                    enSelect.innerHTML = '';

                    const currentTh = localStorage.getItem('thVoiceURI');
                    const currentEn = localStorage.getItem('enVoiceURI');

                    voices.forEach(voice => {
                        const option = document.createElement('option');
                        option.value = voice.voiceURI;
                        option.textContent = `${voice.name} (${voice.lang})`;
                        
                        if (voice.lang.includes('TH')) {
                            const clone = option.cloneNode(true);
                            if (voice.voiceURI === currentTh) clone.selected = true;
                            thSelect.appendChild(clone);
                        }
                        if (voice.lang.includes('EN') || voice.lang.includes('en')) {
                            const clone = option.cloneNode(true);
                            if (voice.voiceURI === currentEn) clone.selected = true;
                            enSelect.appendChild(clone);
                        }
                    });
                };

                populateVoices();
                if (window.speechSynthesis.onvoiceschanged !== undefined) {
                    window.speechSynthesis.onvoiceschanged = populateVoices;
                }

                thSelect.onchange = (e) => localStorage.setItem('thVoiceURI', e.target.value);
                enSelect.onchange = (e) => localStorage.setItem('enVoiceURI', e.target.value);

                testBtn.onclick = () => {
                    SpeechService.speak("‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢", "th-TH", () => {
                        setTimeout(() => {
                            SpeechService.speak("Testing English voice.", "en-US");
                        }, 500);
                    });
                };
            },

            // ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
            renderDashboard() {
                const questions = this.allUserQuestions;
                const now = new Date();
                const dueCount = questions.filter(q => q.next_review_date <= now).length;

                document.getElementById('total-questions').textContent = questions.length;
                document.getElementById('due-for-review').textContent = dueCount;

                // Level Chart
                const levelData = [0, 1, 2, 3, 4, 5, 6].map(lv => 
                    questions.filter(q => q.srs_level === lv).length
                );

                new Chart(document.getElementById('levelChart'), {
                    type: 'bar',
                    data: {
                        labels: ['New', 'Lv.1', 'Lv.2', 'Lv.3', 'Lv.4', 'Lv.5', 'Lv.6'],
                        datasets: [{
                            label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå',
                            data: levelData,
                            backgroundColor: '#3b82f6'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                    }
                });

                // Category Chart
                const categories = {};
                questions.forEach(q => {
                    categories[q.category] = (categories[q.category] || 0) + 1;
                });

                new Chart(document.getElementById('categoryChart'), {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(categories),
                        datasets: [{
                            data: Object.values(categories),
                            backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            },

            async renderHistory() {
                const history = await LocalStorageService.getHistory();
                const container = document.getElementById('history-list-container');
                
                if (history.length === 0) {
                    container.innerHTML = '<p class="text-center text-muted py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô</p>';
                    return;
                }

                // ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô
                const correctCount = history.filter(h => h.is_correct).length;
                document.getElementById('total-sessions').textContent = history.length;
                document.getElementById('total-correct').textContent = correctCount;
                document.getElementById('total-incorrect').textContent = history.length - correctCount;

                let html = `
                    <table class="table table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
                                <th>‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå</th>
                                <th>‡πÇ‡∏´‡∏°‡∏î</th>
                                <th>‡∏ó‡∏µ‡πà‡∏ï‡∏≠‡∏ö‡πÑ‡∏õ</th>
                                <th>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                history.forEach(log => {
                    const q = this.allUserQuestions.find(item => item.id === log.question_id);
                    const timeStr = new Date(log.timestamp).toLocaleString('th-TH', { 
                        month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' 
                    });
                    
                    html += `
                        <tr>
                            <td><small>${timeStr}</small></td>
                            <td><strong>${q ? q.answer : 'N/A'}</strong></td>
                            <td><small>${log.mode === 'typing' ? '‡∏û‡∏¥‡∏°‡∏û‡πå' : '‡∏û‡∏π‡∏î'}</small></td>
                            <td><small class="text-muted">"${log.transcript || '-'}"</small></td>
                            <td>
                                <span class="badge ${log.is_correct ? 'bg-success' : 'bg-danger'}">
                                    ${log.is_correct ? '‡∏ú‡πà‡∏≤‡∏ô' : '‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô'}
                                </span>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            },

            // ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
            startDueItemsCheck() {
                const check = () => {
                    const now = new Date();
                    const dueItems = this.allUserQuestions.filter(q => q.next_review_date <= now);
                    if (dueItems.length > 0) {
                        const toastEl = document.getElementById('due-toast');
                        const toast = bootstrap.Toast.getOrCreateInstance(toastEl);
                        document.getElementById('due-toast-message').textContent = `‡∏°‡∏µ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå ${dueItems.length} ‡∏Ñ‡∏≥ ‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß!`;
                        document.getElementById('start-due-toast-btn').onclick = () => {
                            toast.hide();
                            this.startQuizSession('due');
                        };
                        toast.show();
                    }
                };
                
                check();
                setInterval(check, 60000); // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏∏‡∏Å 1 ‡∏ô‡∏≤‡∏ó‡∏µ
            },

            updateDebugQueue() {
                const debugContainer = document.getElementById('debug-info');
                if (!debugContainer || !this.quizSession.queue) return;

                const queue = this.quizSession.queue.slice(this.quizSession.currentIndex + 1);
                const currentIdShort = this.quizSession.currentQuestion.id.toString().slice(-4);
                let nextIdShort = '-';
                let remainingQueueStr = '[]';

                if (queue && queue.length > 0) {
                    nextIdShort = queue[0].id.toString().slice(-4); 
                    if (queue.length > 1) {
                        remainingQueueStr = `[${queue.slice(1, 10).map(q => q.id.toString().slice(-4)).join(', ')}]`;
                    }
                }

                debugContainer.innerHTML = `
                    <p class="mb-1"><strong>Current ID:</strong> ${currentIdShort}</p>
                    <p class="mb-1"><strong>Next ID:</strong> ${nextIdShort}</p>
                    <p class="mb-0"><strong>Queue:</strong> ${remainingQueueStr}</p>
                `;
            },

            showAlert(msg, type = 'success') {
                const c = document.getElementById('alert-container');
                const el = document.createElement('div');
                el.className = `alert alert-${type} alert-dismissible fade show`;
                el.innerHTML = `${msg}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
                c.appendChild(el);
                setTimeout(() => bootstrap.Alert.getOrCreateInstance(el).close(), 3000);
            }
        };

        // Start App
        document.addEventListener('DOMContentLoaded', () => {
            App.init();
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
